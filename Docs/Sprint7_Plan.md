# Sprint 7 계획서 — 팝업/애드온/밸런싱 버그 수정

**기간**: 2026-02-20
**브랜치**: `sprint/7` (sprint/6 완료 후 master 기준 분기 예정)
**목표**: 총괄PD 베타테스트 중 보고된 UI/게임플레이 버그 3종 수정

---

## 총괄PD 지시 기록 (2026-02-20)

> 운영센터의 팝업이 건물 위치에 안맞게 뜨고 있어. 여기서 무언가 구매나 업그레이드를 하면 제대로 된 위치로 가서 팝업 UI 위치가 자꾸 바뀌는 불편한 현상이 벌어지고 있어 수정해줘

> 애드온의 경우 너무 가격이 싸. 다른 업그레이드보다 훨씬 비싸게 해서 기본 업그레이드 많이 하다가 정체될 때쯤에 애드온 업글이 가능한 느낌으로 밸런싱해줘. / 그리고 애드온은 건물에 딱 붙어있어야되는데 너무 떨어져있어.

> 대부분 건물이 이런식으로 지지대 부분이 중앙이 아니라 좀 오른쪽으로 쏠려 있어. 검토해줘

---

## 조사 결과 요약

### Issue A: 건물 오버레이 팝업 위치 오차
- **위치**: `js/world.js` — `openBldOv()` 함수
- **증상**: 처음 팝업을 열면 위치가 틀림. 구매/업그레이드 실행 후 `renderAll()` → 재렌더링 → 올바른 위치로 이동
- **원인 추정**: 팝업을 열 때 사용하는 `getBoundingClientRect()` 호출 시점에 월드 스크롤 위치나 DOM 레이아웃이 아직 반영되지 않은 상태

### Issue B: 애드온 가격 밸런싱
- **위치**: 애드온 업그레이드 비용 정의 (world.js 또는 game-data.js)
- **증상**: 애드온 업그레이드가 기본 업그레이드보다 너무 저렴 → 게임 초반에 바로 구매 가능
- **목표**: 기본 업그레이드 포화 시점(후반부)에 구매 가능한 수준으로 가격 인상

### Issue C: 애드온 건물 간격 조정
- **위치**: `js/world.js` — `ADDON_POSITIONS` 상수
- **증상**: 애드온 건물이 부모 건물(ops_center, launch_pad)과 너무 멀리 떨어짐
- **목표**: 두 건물이 바로 붙어있는 느낌으로 간격 최소화

### Issue D: 건물 지지대 쏠림 (Sprint 6 수정으로 해소 가능성)
- Sprint 6에서 기반부 앞 공백 제거 완료 → 재배포(surge) 후 시각 확인 필요
- 잔존 시 별도 수정

---

## 작업 항목

### P7-1 (프로그래밍팀장): 오버레이 팝업 위치 오차 수정
**파일**: `js/world.js`
**내용**: `openBldOv()` 에서 팝업 위치 계산 방식 수정
- 현재: 첫 오픈 시 위치 오차 → 구매 후 재렌더링으로 위치 보정
- 수정: 팝업 위치를 `requestAnimationFrame` 또는 다음 프레임에서 계산하거나, 항상 고정 위치(월드 좌표 기반)로 계산하도록 변경

### P7-2 (프로그래밍팀장): 애드온 가격 밸런싱
**파일**: `js/world.js` (애드온 업그레이드 cost 정의 위치)
**내용**: 애드온 업그레이드 비용을 기본 업그레이드 최고 단계보다 훨씬 높게 조정
- 기본 업그레이드 후반부 비용의 5~10배 수준을 목표로 기획팀장과 협의

### P7-3 (프로그래밍팀장): 애드온 건물 간격 최소화
**파일**: `js/world.js` — `ADDON_POSITIONS`
**내용**: 현재 값 조정하여 애드온 건물이 부모 건물에 바로 붙도록 수정
```javascript
// 현재
const ADDON_POSITIONS = {
  ops_center:  1030,  // ops_center @ 860, 건물폭 약 130px → 갭 약 40px
  launch_pad: 2870,   // launch_pad @ 2700, 건물폭 약 130px → 갭 약 40px
};
// 수정 목표: 갭 최소화 (0~5px)
```

### P7-4 (프로그래밍팀장): ASCII 건물 기반부 폭 불일치 추가 수정
**파일**: `js/world.js`
**내용**: Sprint 6에서 미처 발견하지 못한 MISMATCH 3개 그룹 (10개 인스턴스) 수정

전수조사 결과 발견된 불일치:

| 건물 | 라인 | 현재 기반부 | 박스폭 | 기반부폭 | 수정 |
|------|------|------------|--------|---------|------|
| ops_premium tier>=2 | ~148 | `' ██████████'` | 12 | 11 | `'████████████'` |
| ops_premium tier<2  | ~158 | `' ██████████'` | 12 | 11 | `'████████████'` |
| ops_24h tier>=2     | ~168 | `' ██████████'` | 12 | 11 | `'████████████'` |
| ops_24h tier<2      | ~178 | `' ██████████'` | 12 | 11 | `'████████████'` |
| ops_sales tier>=2   | ~188 | `' ██████████'` | 12 | 11 | `'████████████'` |
| ops_sales tier<2    | ~197 | `' ██████████'` | 12 | 11 | `'████████████'` |
| wb-refinery tier>=3 | ~308 | `'███████████'` | 10 | 11 | `'██████████'` |
| wb-refinery tier>=1 | ~318 | `'███████████'` | 10 | 11 | `'██████████'` |
| wb-refinery tier 0  | ~327 | `'███████████'` | 10 | 11 | `'██████████'` |
| _scaffoldAscii      | ~632 | `'  ████████'` |  9 | 10 | `'  ███████'` |

---

## 완료 기준 체크리스트

- [ ] P7-1: 오버레이 팝업이 처음 열릴 때부터 올바른 위치에 표시됨
- [ ] P7-1: 구매/업그레이드 후에도 팝업 위치 변화 없음
- [ ] P7-2: 애드온 업그레이드 가격이 기본 업그레이드 후반 단계보다 훨씬 높음
- [ ] P7-3: 애드온 건물이 부모 건물에 붙어있는 느낌으로 표시됨
- [ ] P7-4: ops 업그레이드 6종 기반부 12자 맞춤 확인
- [ ] P7-4: refinery 3종 기반부 10자 맞춤 확인
- [ ] P7-4: scaffold 기반부 9자 맞춤 확인
- [ ] QA: 시각 확인 (Playwright 스모크 테스트)
- [ ] 총괄PD 보고 후 master 머지 대기

---

## 브랜치 전략

```
master (sprint/6 머지 후)
└── sprint/7 ← sprint/6 기준 신규 분기 (master 컨펌 전 착수)
     └── dev/programmer (P7-1, P7-2, P7-3, P7-4)
```
