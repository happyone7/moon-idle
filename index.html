<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MoonIdle - ë‹¬ íƒì‚¬ ë¡œì¼“ ì œì‘ì†Œ</title>
<meta name="description" content="ìì›ì„ ëª¨ìœ¼ê³  ë¡œì¼“ì„ ì¡°ë¦½í•´ ë‹¬ì— ë„ë‹¬í•˜ëŠ” ë°©ì¹˜í˜• ê²Œì„">
<style>
:root {
  --bg-dark: #0a0e1a;
  --bg-panel: #0f1629;
  --bg-card: #141d35;
  --accent-blue: #4fc3f7;
  --accent-purple: #b39ddb;
  --accent-gold: #ffd54f;
  --accent-green: #69f0ae;
  --accent-red: #ef5350;
  --text-primary: #e8eaf6;
  --text-secondary: #90a4ae;
  --glow-blue: 0 0 12px rgba(79,195,247,0.5);
  --glow-gold: 0 0 12px rgba(255,213,79,0.5);
  --glow-green: 0 0 12px rgba(105,240,174,0.5);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: var(--bg-dark);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}
#stars {
  position: fixed; top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none; z-index: 0;
  background: radial-gradient(ellipse at 50% 30%, #1a2a4a 0%, #0a0e1a 70%);
}
.star {
  position: absolute;
  border-radius: 50%;
  background: white;
  animation: twinkle var(--dur, 3s) ease-in-out infinite;
  animation-delay: var(--delay, 0s);
}
@keyframes twinkle {
  0%,100% { opacity: 0.2; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.3); }
}
#app {
  position: relative; z-index: 1;
  max-width: 1200px;
  margin: 0 auto;
  padding: 16px;
}
header {
  text-align: center;
  padding: 20px 0 16px;
  border-bottom: 1px solid rgba(79,195,247,0.2);
  margin-bottom: 16px;
}
header h1 {
  font-size: 2rem;
  font-weight: 800;
  background: linear-gradient(135deg, #4fc3f7, #b39ddb, #ffd54f);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: 2px;
}
header p { color: var(--text-secondary); font-size: 0.85rem; margin-top: 4px; }
.moonstone-bar {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(255,213,79,0.1);
  border: 1px solid rgba(255,213,79,0.3);
  border-radius: 20px;
  padding: 4px 14px;
  margin-top: 8px;
  font-size: 0.85rem;
  color: var(--accent-gold);
  box-shadow: var(--glow-gold);
}
.header-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin-top: 8px;
  flex-wrap: wrap;
}
.sound-toggle {
  background: var(--bg-card);
  border: 1px solid rgba(79,195,247,0.3);
  border-radius: 20px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.75rem;
  font-weight: 700;
  padding: 5px 12px;
  transition: all 0.2s;
}
.sound-toggle:hover {
  border-color: rgba(79,195,247,0.6);
  box-shadow: var(--glow-blue);
}
.grid {
  display: grid;
  grid-template-columns: 280px 1fr 280px;
  gap: 14px;
}
@media (max-width: 900px) {
  .grid { grid-template-columns: 1fr; }
}
.panel {
  background: var(--bg-panel);
  border: 1px solid rgba(79,195,247,0.15);
  border-radius: 14px;
  padding: 14px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.04);
}
.panel-title {
  font-size: 0.75rem;
  font-weight: 700;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--accent-blue);
  margin-bottom: 12px;
  display: flex; align-items: center; gap: 6px;
}
/* Resources */
.resource-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 10px;
  background: var(--bg-card);
  border-radius: 8px;
  margin-bottom: 6px;
  border: 1px solid rgba(255,255,255,0.04);
  transition: border-color 0.2s;
}
.resource-item:hover { border-color: rgba(79,195,247,0.2); }
.resource-icon { font-size: 1.2rem; width: 28px; text-align: center; }
.resource-info { flex: 1; padding: 0 8px; }
.resource-name { font-size: 0.78rem; color: var(--text-secondary); }
.resource-amount { font-size: 1rem; font-weight: 700; color: var(--text-primary); }
.resource-rate { font-size: 0.72rem; color: var(--accent-green); }
.click-btn {
  background: linear-gradient(135deg, #1565c0, #4fc3f7);
  border: none; border-radius: 6px;
  color: white; cursor: pointer;
  font-size: 0.75rem; font-weight: 600;
  padding: 5px 10px;
  transition: all 0.15s;
  box-shadow: var(--glow-blue);
  white-space: nowrap;
}
.click-btn:hover { transform: translateY(-1px); filter: brightness(1.2); }
.click-btn:active { transform: translateY(0); }
/* Buildings */
.building-item {
  background: var(--bg-card);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 8px;
  transition: all 0.2s;
}
.building-item:hover { border-color: rgba(79,195,247,0.25); }
.building-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.building-name { font-size: 0.85rem; font-weight: 600; }
.building-count {
  background: rgba(79,195,247,0.15);
  color: var(--accent-blue);
  border-radius: 12px;
  padding: 1px 8px;
  font-size: 0.75rem; font-weight: 700;
}
.building-desc { font-size: 0.72rem; color: var(--text-secondary); margin-bottom: 6px; }
.building-cost { font-size: 0.72rem; color: var(--accent-gold); margin-bottom: 6px; }
.buy-btn {
  width: 100%;
  background: linear-gradient(135deg, #1a237e, #283593);
  border: 1px solid rgba(79,195,247,0.3);
  border-radius: 6px;
  color: var(--text-primary);
  cursor: pointer;
  font-size: 0.78rem; font-weight: 600;
  padding: 6px;
  transition: all 0.2s;
}
.buy-btn:hover:not(:disabled) { background: linear-gradient(135deg, #283593, #4fc3f7); box-shadow: var(--glow-blue); }
.buy-btn:disabled { opacity: 0.35; cursor: not-allowed; }
/* Rocket Panel */
.rocket-visual {
  text-align: center;
  font-size: 4rem;
  padding: 10px 0;
  animation: rocketFloat 3s ease-in-out infinite;
}
@keyframes rocketFloat {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}
.rocket-part {
  background: var(--bg-card);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 6px;
  transition: all 0.2s;
}
.rocket-part.complete {
  border-color: rgba(105,240,174,0.4);
  background: rgba(105,240,174,0.05);
}
.part-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.part-name { font-size: 0.82rem; font-weight: 600; }
.part-status { font-size: 0.75rem; }
.part-status.done { color: var(--accent-green); }
.part-status.pending { color: var(--text-secondary); }
.progress-bar {
  background: rgba(255,255,255,0.08);
  border-radius: 4px; height: 6px; overflow: hidden; margin-bottom: 4px;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #4fc3f7, #b39ddb);
  border-radius: 4px;
  transition: width 0.3s ease;
  box-shadow: var(--glow-blue);
}
.rocket-part.complete .progress-fill { background: linear-gradient(90deg, #69f0ae, #4fc3f7); }
.craft-btn {
  width: 100%;
  background: linear-gradient(135deg, #4a148c, #7b1fa2);
  border: 1px solid rgba(179,157,219,0.3);
  border-radius: 6px;
  color: white; cursor: pointer;
  font-size: 0.75rem; font-weight: 600;
  padding: 5px;
  transition: all 0.2s;
  margin-top: 4px;
}
.craft-btn:hover:not(:disabled) { background: linear-gradient(135deg, #6a1b9a, #b39ddb); box-shadow: 0 0 10px rgba(179,157,219,0.4); }
.craft-btn:disabled { opacity: 0.35; cursor: not-allowed; }
.launch-btn {
  width: 100%;
  background: linear-gradient(135deg, #e65100, #ff6d00, #ffd54f);
  border: none; border-radius: 10px;
  color: white; cursor: pointer;
  font-size: 1rem; font-weight: 800;
  padding: 14px;
  margin-top: 10px;
  transition: all 0.3s;
  box-shadow: var(--glow-gold), 0 4px 20px rgba(255,109,0,0.4);
  letter-spacing: 1px;
  display: none;
}
.launch-btn.ready { display: block; animation: pulse 1.5s ease-in-out infinite; }
@keyframes pulse {
  0%,100% { transform: scale(1); box-shadow: var(--glow-gold), 0 4px 20px rgba(255,109,0,0.4); }
  50% { transform: scale(1.03); box-shadow: 0 0 30px rgba(255,213,79,0.8), 0 4px 30px rgba(255,109,0,0.6); }
}
.science-summary {
  background: rgba(79,195,247,0.08);
  border: 1px solid rgba(79,195,247,0.25);
  border-radius: 10px;
  padding: 10px;
  margin-top: 8px;
  margin-bottom: 8px;
  font-size: 0.73rem;
  color: var(--text-secondary);
}
.science-summary b { color: var(--text-primary); }
.assembly-toolbar {
  background: var(--bg-card);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 8px;
}
.assembly-title {
  font-size: 0.76rem;
  color: var(--accent-blue);
  margin-bottom: 6px;
  font-weight: 700;
}
.quality-select {
  width: 100%;
  background: #0b1328;
  border: 1px solid rgba(79,195,247,0.3);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 0.75rem;
  padding: 6px;
}
.slot-item {
  background: var(--bg-card);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 10px;
  padding: 9px;
  margin-bottom: 7px;
}
.slot-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 4px;
  font-size: 0.74rem;
}
.slot-status {
  font-size: 0.7rem;
}
.slot-status.ready { color: var(--accent-green); }
.slot-status.busy { color: var(--accent-gold); }
.slot-status.idle { color: var(--text-secondary); }
.slot-row-note {
  font-size: 0.68rem;
  color: var(--text-secondary);
  margin-bottom: 4px;
}
.slot-btn {
  width: 100%;
  border: 1px solid rgba(79,195,247,0.3);
  border-radius: 7px;
  background: linear-gradient(135deg, #0d47a1, #1565c0);
  color: white;
  font-size: 0.72rem;
  font-weight: 700;
  padding: 6px;
  cursor: pointer;
}
.slot-btn:disabled { opacity: 0.35; cursor: not-allowed; }
.slot-btn.launch {
  background: linear-gradient(135deg, #e65100, #ff6d00);
  border-color: rgba(255,109,0,0.6);
}
/* Upgrades */
.upgrade-item {
  background: var(--bg-card);
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 6px;
  transition: all 0.2s;
}
.upgrade-item.purchased { border-color: rgba(105,240,174,0.3); opacity: 0.6; }
.upgrade-item:hover:not(.purchased) { border-color: rgba(179,157,219,0.3); }
.upgrade-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
.upgrade-name { font-size: 0.82rem; font-weight: 600; }
.upgrade-desc { font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 5px; }
.upgrade-cost { font-size: 0.7rem; color: var(--accent-purple); margin-bottom: 5px; }
.upg-btn {
  width: 100%;
  background: linear-gradient(135deg, #1b5e20, #2e7d32);
  border: 1px solid rgba(105,240,174,0.25);
  border-radius: 6px;
  color: white; cursor: pointer;
  font-size: 0.75rem; font-weight: 600;
  padding: 5px;
  transition: all 0.2s;
}
.upg-btn:hover:not(:disabled) { background: linear-gradient(135deg, #2e7d32, #69f0ae); color: #000; }
.upg-btn:disabled { opacity: 0.35; cursor: not-allowed; }
/* Notifications */
#notif {
  position: fixed; bottom: 20px; right: 20px;
  z-index: 100; display: flex; flex-direction: column; gap: 8px;
}
.notif-item {
  background: var(--bg-panel);
  border: 1px solid rgba(79,195,247,0.3);
  border-radius: 10px;
  padding: 10px 16px;
  font-size: 0.82rem;
  box-shadow: var(--glow-blue);
  animation: slideIn 0.3s ease, fadeOut 0.5s ease 2.5s forwards;
  max-width: 280px;
}
@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes fadeOut { to { opacity: 0; transform: translateX(100%); } }
/* Launch overlay */
#launch-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.92);
  z-index: 200;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}
#launch-overlay.show { display: flex; }
#launch-overlay h2 {
  font-size: 2.5rem; font-weight: 800;
  background: linear-gradient(135deg, #ffd54f, #ff6d00);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 16px;
}
#launch-overlay p { color: var(--text-secondary); margin-bottom: 24px; font-size: 1rem; }
.moon-emoji { font-size: 6rem; animation: moonBounce 1s ease-in-out infinite; }
@keyframes moonBounce { 0%,100% { transform: scale(1) rotate(-5deg); } 50% { transform: scale(1.1) rotate(5deg); } }
.prestige-btn {
  background: linear-gradient(135deg, #ffd54f, #ff6d00);
  border: none; border-radius: 12px;
  color: #000; cursor: pointer;
  font-size: 1rem; font-weight: 800;
  padding: 14px 32px;
  transition: all 0.2s;
  box-shadow: var(--glow-gold);
  margin-top: 16px;
}
.prestige-btn:hover { transform: scale(1.05); }
.offline-banner {
  background: rgba(255,213,79,0.1);
  border: 1px solid rgba(255,213,79,0.3);
  border-radius: 10px;
  padding: 10px 14px;
  margin-bottom: 14px;
  font-size: 0.82rem;
  color: var(--accent-gold);
  display: none;
}
.tab-bar {
  display: flex; gap: 6px; margin-bottom: 10px;
}
.tab {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid rgba(255,255,255,0.06);
  border-radius: 8px;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 0.75rem; font-weight: 600;
  padding: 7px;
  text-align: center;
  transition: all 0.2s;
}
.tab.active {
  background: rgba(79,195,247,0.15);
  border-color: rgba(79,195,247,0.4);
  color: var(--accent-blue);
}
.tab-content { display: none; }
.tab-content.active { display: block; }
</style>
</head>
<body>
<div id="stars"></div>
<div id="app">
  <header>
    <h1>ğŸš€ MOON IDLE</h1>
    <p>ìì›ì„ ëª¨ìœ¼ê³  ë¡œì¼“ì„ ì¡°ë¦½í•´ ë‹¬ì— ë„ë‹¬í•˜ë¼!</p>
    <div class="header-controls">
      <div class="moonstone-bar" id="moonstone-display" style="display:none">
        ğŸŒ™ ë¬¸ìŠ¤í†¤: <span id="moonstone-count">0</span> (+<span id="moonstone-bonus">0</span>% ìƒì‚° ë³´ë„ˆìŠ¤)
      </div>
      <button class="sound-toggle" id="sound-toggle" onclick="toggleSound()">ğŸ”Š ì‚¬ìš´ë“œ ON</button>
    </div>
  </header>

  <div id="offline-banner" class="offline-banner"></div>

  <div class="grid">
    <!-- LEFT: Resources -->
    <div class="panel">
      <div class="panel-title">ğŸ“¦ ìì›</div>
      <div id="resources-list"></div>
    </div>

    <!-- CENTER: Buildings + Upgrades -->
    <div class="panel">
      <div class="tab-bar">
        <button class="tab active" onclick="switchTab('buildings')">ğŸ­ ì‹œì„¤</button>
        <button class="tab" onclick="switchTab('upgrades')">ğŸ”¬ ì—…ê·¸ë ˆì´ë“œ</button>
      </div>
      <div id="tab-buildings" class="tab-content active">
        <div id="buildings-list"></div>
      </div>
      <div id="tab-upgrades" class="tab-content">
        <div id="upgrades-list"></div>
      </div>
    </div>

    <!-- RIGHT: Rocket -->
    <div class="panel">
      <div class="panel-title">ğŸš€ ë¡œì¼“ ì¡°ë¦½</div>
      <div class="rocket-visual" id="rocket-emoji">ğŸš€</div>
      <div id="parts-list"></div>
      <div id="science-summary" class="science-summary"></div>
      <div id="assembly-controls"></div>
      <div id="assembly-slots"></div>
    </div>
  </div>
</div>

<div id="notif"></div>

<div id="launch-overlay">
  <div class="moon-emoji">ğŸŒ™</div>
  <h2>ë‹¬ íƒì‚¬ ì„±ê³µ!</h2>
  <p id="launch-msg">ë¡œì¼“ì´ ë‹¬ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤!<br>ë¬¸ìŠ¤í†¤ì„ íšë“í•˜ê³  ë” ê°•ë ¥í•˜ê²Œ ì¬ì‹œì‘í•˜ì„¸ìš”.</p>
  <div style="font-size:0.9rem;color:var(--accent-gold);margin-bottom:8px" id="moonstone-earned"></div>
  <button class="prestige-btn" onclick="prestige()">ğŸŒ™ ë¬¸ìŠ¤í†¤ íšë“ í›„ ì¬ì‹œì‘</button>
</div>

<script>
// ==================== GAME DATA ====================
const RESOURCES = [
  { id:'metal',       name:'ê¸ˆì†',     icon:'ğŸª¨', color:'#90a4ae' },
  { id:'fuel',        name:'ì—°ë£Œ',     icon:'â›½', color:'#ef9a9a' },
  { id:'electronics', name:'ì „ìë¶€í’ˆ', icon:'ğŸ’¡', color:'#fff176' },
  { id:'research',    name:'ì—°êµ¬ í¬ì¸íŠ¸', icon:'ğŸ”¬', color:'#b39ddb' },
];

const BUILDINGS = [
  { id:'mine',           name:'ê´‘ì‚°',     icon:'â›ï¸',  desc:'ê¸ˆì† ìë™ ì±„êµ´',      produces:'metal',       baseRate:1,   baseCost:{metal:10} },
  { id:'refinery',       name:'ì •ìœ ì†Œ',   icon:'ğŸ›¢ï¸',  desc:'ì—°ë£Œ ìë™ ìƒì‚°',      produces:'fuel',        baseRate:0.8, baseCost:{metal:30, fuel:0} },
  { id:'electronicsLab', name:'ì „ìê³µì¥', icon:'ğŸ­',  desc:'ì „ìë¶€í’ˆ ìƒì‚°',       produces:'electronics', baseRate:0.5, baseCost:{metal:80, fuel:20} },
  { id:'researchLab',    name:'ì—°êµ¬ì†Œ',   icon:'ğŸ”­',  desc:'ì—°êµ¬ í¬ì¸íŠ¸ ìƒì‚°',    produces:'research',    baseRate:0.3, baseCost:{metal:200, electronics:10} },
  { id:'solarArray',     name:'íƒœì–‘ê´‘ íŒ¨ë„', icon:'â˜€ï¸', desc:'ëª¨ë“  ìƒì‚° +10%',    produces:'bonus',       baseRate:0,   baseCost:{metal:500, electronics:50} },
  { id:'launchPad',      name:'ë¡œì¼“ ë°œì‚¬ëŒ€', icon:'ğŸ›°ï¸', desc:'ì¡°ë¦½ ìŠ¬ë¡¯ +1, ëŒ€ëŸ‰ ë°œì‚¬ ì¸í”„ë¼', produces:'slots', baseRate:0, baseCost:{metal:1500, electronics:250, research:250} },
];

const PARTS = [
  { id:'engine',    name:'ì—”ì§„',       icon:'ğŸ”¥', cost:{metal:900,  electronics:450}, desc:'ë¡œì¼“ ì¶”ì§„ ì‹œìŠ¤í…œ' },
  { id:'fuelTank',  name:'ì—°ë£Œ íƒ±í¬',  icon:'ğŸ›¢ï¸', cost:{metal:600,  fuel:2200},       desc:'ê³ ì•• ì—°ë£Œ ì €ì¥ì†Œ' },
  { id:'control',   name:'ì œì–´ ì‹œìŠ¤í…œ', icon:'ğŸ–¥ï¸', cost:{electronics:900, research:600}, desc:'ë¹„í–‰ ì œì–´ ì»´í“¨í„°' },
  { id:'hull',      name:'ì„ ì²´',       icon:'ğŸ”©', cost:{metal:2200, fuel:450},         desc:'ë‚´ì—´ í•©ê¸ˆ ì„ ì²´' },
  { id:'payload',   name:'íƒ‘ì¬ì²´',     icon:'ğŸ“¡', cost:{electronics:700, research:1400}, desc:'ë‹¬ íƒì‚¬ ì¥ë¹„' },
];

const ROCKET_QUALITIES = [
  { id:'proto',  name:'ê¶¤ë„ ì‹œì œê¸°', icon:'ğŸ§ª', costMult:1.0, timeSec:1800, ispBonus:0,  dryMassMult:1.0, relBonus:0,  reuseBonus:0,  rewardMult:1.0 },
  { id:'block1', name:'Block-I',   icon:'ğŸš€', costMult:1.5, timeSec:3600, ispBonus:12, dryMassMult:0.95, relBonus:6,  reuseBonus:8,  rewardMult:1.6 },
  { id:'block2', name:'Block-II',  icon:'ğŸ›°ï¸', costMult:2.4, timeSec:7200, ispBonus:24, dryMassMult:0.9,  relBonus:10, reuseBonus:14, rewardMult:2.4 },
  { id:'heavy',  name:'Heavy',     icon:'ğŸŒŒ', costMult:4.0, timeSec:14400,ispBonus:38, dryMassMult:0.84, relBonus:16, reuseBonus:22, rewardMult:3.8 },
];
const SAVE_VERSION = 2;

const UPGRADES = [
  { id:'mining1',    name:'ì±„êµ´ íš¨ìœ¨ I',   icon:'â›ï¸', desc:'ê¸ˆì† ìƒì‚° +50%',        cost:{research:50},  effect:()=>{ prodMult.metal=(prodMult.metal||1)*1.5; } },
  { id:'mining2',    name:'ì±„êµ´ íš¨ìœ¨ II',  icon:'â›ï¸', desc:'ê¸ˆì† ìƒì‚° +100%',       cost:{research:200}, effect:()=>{ prodMult.metal=(prodMult.metal||1)*2; },   req:'mining1' },
  { id:'fuel1',      name:'ì—°ë£Œ ì••ì¶• I',   icon:'â›½', desc:'ì—°ë£Œ ìƒì‚° +50%',         cost:{research:80},  effect:()=>{ prodMult.fuel=(prodMult.fuel||1)*1.5; } },
  { id:'fuel2',      name:'ì—°ë£Œ ì••ì¶• II',  icon:'â›½', desc:'ì—°ë£Œ ìƒì‚° +100%',        cost:{research:300}, effect:()=>{ prodMult.fuel=(prodMult.fuel||1)*2; },    req:'fuel1' },
  { id:'auto1',      name:'ìë™í™” I',      icon:'ğŸ¤–', desc:'ëª¨ë“  ìƒì‚° +25%',         cost:{research:150}, effect:()=>{ globalMult*=1.25; } },
  { id:'auto2',      name:'ìë™í™” II',     icon:'ğŸ¤–', desc:'ëª¨ë“  ìƒì‚° +50%',         cost:{research:500}, effect:()=>{ globalMult*=1.5; },                       req:'auto1' },
  { id:'lightweight',name:'ê²½ëŸ‰ ì†Œì¬',     icon:'ğŸª¶', desc:'ë¡œì¼“ ë¶€í’ˆ ë¹„ìš© -25%',   cost:{research:400}, effect:()=>{ partCostMult=0.75; } },
  { id:'fusion',     name:'í•µìœµí•© ì—”ì§„',   icon:'âš›ï¸', desc:'ë¬¸ìŠ¤í†¤ íšë“ëŸ‰ +2',      cost:{research:1000},effect:()=>{ fusionBonus=2; } },
  { id:'qaRig',      name:'í’ˆì§ˆ ì‹œí—˜ëŒ€',   icon:'ğŸ§°', desc:'ì‹ ë¢°ë„ +8%',             cost:{research:900}, effect:()=>{ reliabilityBonus += 8; },                 req:'auto1' },
  { id:'padOps',     name:'ë°œì‚¬ ìš´ì˜ AI',  icon:'ğŸ§ ', desc:'ì¡°ë¦½ ìŠ¬ë¡¯ +1',           cost:{research:1800},effect:()=>{ slotBonus += 1; },                        req:'qaRig' },
];

// ==================== GAME STATE ====================
let gs = {
  res: { metal:0, fuel:0, electronics:0, research:0 },
  buildings: { mine:0, refinery:0, electronicsLab:0, researchLab:0, solarArray:0, launchPad:0 },
  parts: { engine:0, fuelTank:0, control:0, hull:0, payload:0 },
  upgrades: {},
  assembly: {
    selectedQuality: 'proto',
    jobs: []
  },
  moonstone: 0,
  launches: 0,
  settings: { sound: true },
  lastTick: Date.now(),
};
let prodMult = {};
let globalMult = 1;
let partCostMult = 1;
let fusionBonus = 0;
let reliabilityBonus = 0;
let slotBonus = 0;
let audioCtx = null;

// ==================== HELPERS ====================
function fmt(n) {
  if (n >= 1e12) return (n/1e12).toFixed(2)+'T';
  if (n >= 1e9)  return (n/1e9).toFixed(2)+'B';
  if (n >= 1e6)  return (n/1e6).toFixed(2)+'M';
  if (n >= 1e3)  return (n/1e3).toFixed(2)+'K';
  return Math.floor(n).toString();
}
function fmtDec(n) {
  if (n >= 1000) return fmt(n);
  return n.toFixed(1);
}
function fmtTime(sec) {
  const s = Math.max(0, Math.floor(sec));
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const r = s % 60;
  if (h > 0) return `${h}h ${m}m`;
  if (m > 0) return `${m}m ${r}s`;
  return `${r}s`;
}
function clamp(v, min, max) {
  return Math.min(max, Math.max(min, v));
}
function getQuality(qid) {
  return ROCKET_QUALITIES.find(q => q.id === qid) || ROCKET_QUALITIES[0];
}
function getAssemblySlots() {
  return 1 + gs.buildings.launchPad + slotBonus;
}
function ensureAssemblyState() {
  if (!gs.assembly) gs.assembly = { selectedQuality:'proto', jobs:[] };
  if (!Array.isArray(gs.assembly.jobs)) gs.assembly.jobs = [];
  if (!gs.assembly.selectedQuality) gs.assembly.selectedQuality = 'proto';
  const slots = getAssemblySlots();
  while (gs.assembly.jobs.length < slots) gs.assembly.jobs.push(null);
  if (gs.assembly.jobs.length > slots) gs.assembly.jobs = gs.assembly.jobs.slice(0, slots);
}
function getAssemblyCost(qualityId) {
  const q = getQuality(qualityId);
  const total = { metal:0, fuel:0, electronics:0, research:0 };
  PARTS.forEach(p => {
    const c = getPartCost(p);
    Object.entries(c).forEach(([r,v]) => {
      total[r] = (total[r] || 0) + Math.floor(v * q.costMult * 0.32);
    });
  });
  return total;
}
function getRocketScience(qualityId) {
  const q = getQuality(qualityId);
  const tech = {
    mine: gs.buildings.mine,
    lab: gs.buildings.researchLab,
    elec: gs.buildings.electronicsLab
  };
  const isp = 315 + q.ispBonus + tech.elec * 1.2 + (gs.upgrades.fusion ? 22 : 0);
  const dryMass = 28 * q.dryMassMult * (gs.upgrades.lightweight ? 0.9 : 1);
  const propMass = 76 + gs.buildings.refinery * 0.1;
  const thrust = 1450 + tech.mine * 0.8 + (gs.upgrades.fusion ? 120 : 0);
  const m0 = dryMass + propMass;
  const mf = dryMass;
  const deltaV = (isp * 9.81 * Math.log(m0 / mf)) / 1000;
  const twr = thrust / (m0 * 9.81);
  const reliability = clamp(56 + tech.lab * 1.9 + tech.elec * 0.8 + reliabilityBonus + q.relBonus, 35, 99.5);
  const reusability = clamp(6 + gs.buildings.launchPad * 4 + q.reuseBonus + (gs.upgrades.lightweight ? 8 : 0), 0, 95);
  const score = deltaV * 11 + twr * 26 + reliability * 0.7 + reusability * 0.3;
  return { deltaV, twr, reliability, reusability, score };
}
function getMoonstoneRewardForQuality(qualityId) {
  const q = getQuality(qualityId);
  const sci = getRocketScience(qualityId);
  const qualityBonus = Math.floor((sci.score / 160) * q.rewardMult);
  const missionBonus = Math.floor(gs.launches / 4);
  return Math.max(1, 1 + fusionBonus + qualityBonus + missionBonus);
}
function canAfford(cost) {
  return Object.entries(cost).every(([r,v]) => gs.res[r] >= v);
}
function spend(cost) {
  Object.entries(cost).forEach(([r,v]) => gs.res[r] -= v);
}
function notify(msg, color='var(--accent-blue)') {
  const el = document.createElement('div');
  el.className = 'notif-item';
  el.style.borderColor = color;
  el.textContent = msg;
  document.getElementById('notif').appendChild(el);
  setTimeout(() => el.remove(), 3200);
}
function ensureAudioContext() {
  if (!audioCtx) {
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return null;
    audioCtx = new Ctx();
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}
function playSfx(type='sine', freq=440, duration=0.08, volume=0.03, targetFreq=null) {
  if (!gs.settings?.sound) return;
  const ctx = ensureAudioContext();
  if (!ctx) return;
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  const now = ctx.currentTime;
  osc.type = type;
  osc.frequency.setValueAtTime(freq, now);
  if (targetFreq) osc.frequency.exponentialRampToValueAtTime(targetFreq, now + duration);
  gain.gain.setValueAtTime(volume, now);
  gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start(now);
  osc.stop(now + duration);
}
function playLaunchSfx() {
  if (!gs.settings?.sound) return;
  playSfx('triangle', 280, 0.12, 0.04, 380);
  setTimeout(() => playSfx('triangle', 420, 0.16, 0.05, 620), 120);
  setTimeout(() => playSfx('sawtooth', 680, 0.22, 0.04, 980), 250);
}
function toggleSound() {
  gs.settings.sound = !gs.settings.sound;
  renderSoundToggle();
  saveGame();
  notify(gs.settings.sound ? 'ğŸ”Š ì‚¬ìš´ë“œ ON' : 'ğŸ”‡ ì‚¬ìš´ë“œ OFF', 'var(--accent-blue)');
  if (gs.settings.sound) playSfx('sine', 640, 0.06, 0.03, 720);
}
function renderSoundToggle() {
  const btn = document.getElementById('sound-toggle');
  if (!btn) return;
  btn.textContent = gs.settings?.sound ? 'ğŸ”Š ì‚¬ìš´ë“œ ON' : 'ğŸ”‡ ì‚¬ìš´ë“œ OFF';
}
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', ['buildings','upgrades'][i]===tab));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
}

// ==================== PRODUCTION ====================
function getMoonstoneMult() {
  return 1 + gs.moonstone * 0.05;
}
function getBuildingRate(b) {
  const bld = BUILDINGS.find(x=>x.id===b.id);
  if (!bld || bld.produces==='bonus') return 0;
  const mult = (prodMult[bld.produces]||1) * globalMult * getMoonstoneMult();
  return bld.baseRate * gs.buildings[b.id] * mult;
}
function getSolarBonus() {
  return 1 + gs.buildings.solarArray * 0.1;
}
function getProduction() {
  const prod = { metal:0, fuel:0, electronics:0, research:0 };
  BUILDINGS.forEach(b => {
    if (b.produces !== 'bonus' && Object.prototype.hasOwnProperty.call(prod, b.produces)) {
      const rate = b.baseRate * gs.buildings[b.id] * (prodMult[b.produces]||1) * globalMult * getMoonstoneMult() * getSolarBonus();
      prod[b.produces] = (prod[b.produces]||0) + rate;
    }
  });
  return prod;
}
function tick() {
  const now = Date.now();
  const dt = Math.min((now - gs.lastTick) / 1000, 1);
  gs.lastTick = now;
  const prod = getProduction();
  RESOURCES.forEach(r => { gs.res[r.id] += prod[r.id] * dt; });
  updateAssemblyJobs(now);
}
function calcOffline() {
  const now = Date.now();
  const elapsed = Math.min((now - gs.lastTick) / 1000, 8*3600);
  if (elapsed < 5) return;
  const prod = getProduction();
  RESOURCES.forEach(r => { gs.res[r.id] += prod[r.id] * elapsed; });
  gs.lastTick = now;
  const mins = Math.floor(elapsed/60);
  updateAssemblyJobs(now);
  if (mins > 0) {
    const banner = document.getElementById('offline-banner');
    banner.style.display = 'block';
    banner.textContent = `â° ì˜¤í”„ë¼ì¸ ${mins}ë¶„ ë™ì•ˆ ìì›ì´ ìƒì‚°ë˜ì—ˆìŠµë‹ˆë‹¤!`;
    setTimeout(() => banner.style.display='none', 5000);
  }
}

// ==================== BUILDING COST ====================
function getBuildingCost(bld) {
  const cost = {};
  Object.entries(bld.baseCost).forEach(([r,v]) => {
    cost[r] = Math.floor(v * Math.pow(1.15, gs.buildings[bld.id]));
  });
  return cost;
}
function getPartCost(part) {
  const cost = {};
  Object.entries(part.cost).forEach(([r,v]) => { cost[r] = Math.floor(v * partCostMult); });
  return cost;
}

// ==================== ACTIONS ====================
function clickResource(rid) {
  const mult = getMoonstoneMult() * globalMult;
  const amt = (prodMult[rid]||1) * mult;
  gs.res[rid] += amt;
  playSfx('sine', 480, 0.04, 0.012, 560);
}
function buyBuilding(bid) {
  const bld = BUILDINGS.find(b=>b.id===bid);
  const cost = getBuildingCost(bld);
  if (!canAfford(cost)) return;
  spend(cost);
  gs.buildings[bid]++;
  notify(`${bld.icon} ${bld.name} ê±´ì„¤ ì™„ë£Œ! (${gs.buildings[bid]}ê°œ)`);
  playSfx('triangle', 360, 0.08, 0.03, 520);
  renderAll();
}
function craftPart(pid) {
  const part = PARTS.find(p=>p.id===pid);
  const cost = getPartCost(part);
  if (!canAfford(cost) || gs.parts[pid]) return;
  spend(cost);
  gs.parts[pid] = 1;
  notify(`${part.icon} ${part.name} ì œì‘ ì™„ë£Œ!`, 'var(--accent-green)');
  playSfx('square', 520, 0.11, 0.03, 760);
  renderAll();
}
function buyUpgrade(uid) {
  const upg = UPGRADES.find(u=>u.id===uid);
  if (!upg || gs.upgrades[uid] || !canAfford(upg.cost)) return;
  if (upg.req && !gs.upgrades[upg.req]) return;
  spend(upg.cost);
  gs.upgrades[uid] = true;
  upg.effect();
  notify(`${upg.icon} ${upg.name} ì—°êµ¬ ì™„ë£Œ!`, 'var(--accent-purple)');
  playSfx('sawtooth', 440, 0.1, 0.028, 700);
  renderAll();
}
function selectQuality(qid) {
  gs.assembly.selectedQuality = qid;
  renderAll();
}
function updateAssemblyJobs(now = Date.now()) {
  ensureAssemblyState();
  for (let i = 0; i < gs.assembly.jobs.length; i++) {
    const job = gs.assembly.jobs[i];
    if (!job || job.ready) continue;
    if (now >= job.endAt) {
      job.ready = true;
      notify(`ğŸ› ï¸ ìŠ¬ë¡¯ ${i+1}: ${getQuality(job.qualityId).name} ì¡°ë¦½ ì™„ë£Œ`, 'var(--accent-green)');
    }
  }
}
function startAssembly(slotIdx) {
  ensureAssemblyState();
  if (!PARTS.every(p => gs.parts[p.id])) {
    notify('ë¨¼ì € ì—”ì§„/íƒ±í¬/ì œì–´/ì„ ì²´/íƒ‘ì¬ì²´ë¥¼ ëª¨ë‘ ì™„ì„±í•˜ì„¸ìš”.', 'var(--accent-red)');
    return;
  }
  if (gs.assembly.jobs[slotIdx]) return;
  const q = getQuality(gs.assembly.selectedQuality);
  const cost = getAssemblyCost(q.id);
  if (!canAfford(cost)) return;
  spend(cost);
  const now = Date.now();
  gs.assembly.jobs[slotIdx] = {
    qualityId: q.id,
    startAt: now,
    endAt: now + q.timeSec * 1000,
    ready: false
  };
  notify(`ğŸš€ ìŠ¬ë¡¯ ${slotIdx+1}: ${q.name} ì¡°ë¦½ ì‹œì‘ (${fmtTime(q.timeSec)})`);
  playSfx('triangle', 310, 0.09, 0.03, 430);
  renderAll();
}
function launchFromSlot(slotIdx) {
  ensureAssemblyState();
  const job = gs.assembly.jobs[slotIdx];
  if (!job || !job.ready) return;
  const q = getQuality(job.qualityId);
  const sci = getRocketScience(q.id);
  const earned = getMoonstoneRewardForQuality(q.id);
  gs.assembly.jobs[slotIdx] = null;
  gs.launches += 1;
  const msg = `${q.icon} ${q.name} ë°œì‚¬ ì„±ê³µ | Î”v ${sci.deltaV.toFixed(2)}km/s Â· TWR ${sci.twr.toFixed(2)} Â· ì‹ ë¢°ë„ ${sci.reliability.toFixed(1)}%`;
  document.getElementById('launch-msg').innerHTML = `${msg}<br>ë¬¸ìŠ¤í†¤ì„ íšë“í•˜ê³  ë” ê°•í•˜ê²Œ í™•ì¥í•˜ì„¸ìš”.`;
  document.getElementById('moonstone-earned').textContent = `ğŸŒ™ ë¬¸ìŠ¤í†¤ +${earned}ê°œ íšë“!`;
  document.getElementById('launch-overlay').classList.add('show');
  playLaunchSfx();
  window._pendingMoonstone = earned;
}
function prestige() {
  gs.moonstone += window._pendingMoonstone || 1;
  // reset but keep moonstone & launches
  gs.res = { metal:0, fuel:0, electronics:0, research:0 };
  gs.buildings = { mine:0, refinery:0, electronicsLab:0, researchLab:0, solarArray:0, launchPad:0 };
  gs.parts = { engine:0, fuelTank:0, control:0, hull:0, payload:0 };
  gs.assembly = { selectedQuality:'proto', jobs:[] };
  gs.upgrades = {};
  prodMult = {};
  globalMult = 1;
  partCostMult = 1;
  fusionBonus = 0;
  reliabilityBonus = 0;
  slotBonus = 0;
  document.getElementById('launch-overlay').classList.remove('show');
  notify(`ğŸŒ™ ë¬¸ìŠ¤í†¤ ${gs.moonstone}ê°œ ë³´ìœ  | ë‹¤ìŒ ì„¸ëŒ€ ìƒì‚° +${gs.moonstone*5}%`, 'var(--accent-gold)');
  playSfx('triangle', 500, 0.12, 0.04, 760);
  saveGame();
  renderAll();
}

// ==================== RENDER ====================
function renderResources() {
  const prod = getProduction();
  const html = RESOURCES.map(r => {
    const rate = prod[r.id];
    return `<div class="resource-item">
      <div class="resource-icon">${r.icon}</div>
      <div class="resource-info">
        <div class="resource-name">${r.name}</div>
        <div class="resource-amount" style="color:${r.color}">${fmt(gs.res[r.id])}</div>
        ${rate>0?`<div class="resource-rate">+${fmtDec(rate)}/s</div>`:''}
      </div>
      <button class="click-btn" onclick="clickResource('${r.id}')">+í´ë¦­</button>
    </div>`;
  }).join('');
  document.getElementById('resources-list').innerHTML = html;
}
function renderBuildings() {
  const html = BUILDINGS.map(b => {
    const cost = getBuildingCost(b);
    const affordable = canAfford(cost);
    const costStr = Object.entries(cost).map(([r,v])=>`${RESOURCES.find(x=>x.id===r)?.icon||''}${fmt(v)}`).join(' ');
    let rateStr = `${RESOURCES.find(x=>x.id===b.produces)?.icon} +${fmtDec(b.baseRate * (prodMult[b.produces]||1) * globalMult * getMoonstoneMult() * getSolarBonus())}/s`;
    if (b.produces==='bonus') rateStr = `íƒœì–‘ê´‘: ìƒì‚° +${(gs.buildings[b.id]*10)}%`;
    if (b.produces==='slots') rateStr = `ì¡°ë¦½ ìŠ¬ë¡¯ +${gs.buildings[b.id]} (í˜„ì¬ ${getAssemblySlots()} ìŠ¬ë¡¯)`;
    return `<div class="building-item">
      <div class="building-header">
        <div class="building-name">${b.icon} ${b.name}</div>
        <div class="building-count">${gs.buildings[b.id]}</div>
      </div>
      <div class="building-desc">${b.desc} Â· ${rateStr}</div>
      <div class="building-cost">ğŸ’° ${costStr}</div>
      <button class="buy-btn" onclick="buyBuilding('${b.id}')" ${affordable?'':'disabled'}>êµ¬ë§¤</button>
    </div>`;
  }).join('');
  document.getElementById('buildings-list').innerHTML = html;
}
function renderParts() {
  ensureAssemblyState();
  const html = PARTS.map(p => {
    const cost = getPartCost(p);
    const done = gs.parts[p.id];
    const affordable = canAfford(cost);
    const costStr = Object.entries(cost).map(([r,v])=>`${RESOURCES.find(x=>x.id===r)?.icon||''}${fmt(v)}`).join(' ');
    // progress: how close to affording
    const progress = done ? 100 : Math.min(100, Math.min(...Object.entries(cost).map(([r,v])=>gs.res[r]/v*100)));
    return `<div class="rocket-part ${done?'complete':''}">
      <div class="part-header">
        <div class="part-name">${p.icon} ${p.name}</div>
        <div class="part-status ${done?'done':'pending'}">${done?'âœ… ì™„ë£Œ':'â³ ì œì‘ ì¤‘'}</div>
      </div>
      <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
      ${!done?`<div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:4px">ğŸ’° ${costStr}</div>`:''}
      ${!done?`<button class="craft-btn" onclick="craftPart('${p.id}')" ${affordable?'':'disabled'}>ì œì‘</button>`:''}
    </div>`;
  }).join('');
  document.getElementById('parts-list').innerHTML = html;
}
function renderScienceSummary() {
  ensureAssemblyState();
  const q = getQuality(gs.assembly.selectedQuality);
  const sci = getRocketScience(q.id);
  const reward = getMoonstoneRewardForQuality(q.id);
  const firstFlowHint = `ì²« ë¡œì¼“ ëª©í‘œ íë¦„: ì•½ 1~2ì‹œê°„ (ìì› ìƒì‚°/ì—°êµ¬ ì—…ê·¸ë ˆì´ë“œì— ë”°ë¼ ë‹¨ì¶•)`;
  document.getElementById('science-summary').innerHTML = `
    <div><b>${q.icon} ${q.name}</b> Â· ì˜ˆìƒ ì¡°ë¦½ ${fmtTime(q.timeSec)}</div>
    <div>Î”v: <b>${sci.deltaV.toFixed(2)} km/s</b> (Tsiolkovsky ê·¼ì‚¬)</div>
    <div>TWR: <b>${sci.twr.toFixed(2)}</b> Â· ì‹ ë¢°ë„: <b>${sci.reliability.toFixed(1)}%</b> Â· ì¬ì‚¬ìš©ì„±: <b>${sci.reusability.toFixed(1)}%</b></div>
    <div>ì˜ˆìƒ ë¬¸ìŠ¤í†¤ ë³´ìƒ: <b>+${reward}</b></div>
    <div style="margin-top:4px">${firstFlowHint}</div>
  `;
}
function renderAssembly() {
  ensureAssemblyState();
  const qualityOptions = ROCKET_QUALITIES.map(q =>
    `<option value="${q.id}" ${gs.assembly.selectedQuality===q.id?'selected':''}>${q.icon} ${q.name} Â· ${fmtTime(q.timeSec)} Â· ë¹„ìš©x${q.costMult.toFixed(1)}</option>`
  ).join('');
  document.getElementById('assembly-controls').innerHTML = `
    <div class="assembly-toolbar">
      <div class="assembly-title">ğŸ”§ ì¡°ë¦½ í’ˆì§ˆ ì„¤ì • (ê³ ê¸‰ ë¡œì¼“ì¼ìˆ˜ë¡ ì˜¤ë˜ ê±¸ë¦¬ì§€ë§Œ ë³´ìƒ ì¦ê°€)</div>
      <select class="quality-select" onchange="selectQuality(this.value)">${qualityOptions}</select>
    </div>
  `;

  const slotsHtml = gs.assembly.jobs.map((job, idx) => {
    if (!job) {
      const cost = getAssemblyCost(gs.assembly.selectedQuality);
      const costStr = Object.entries(cost).map(([r,v])=>`${RESOURCES.find(x=>x.id===r)?.icon||''}${fmt(v)}`).join(' ');
      const canStart = PARTS.every(p => gs.parts[p.id]) && canAfford(cost);
      return `<div class="slot-item">
        <div class="slot-header"><span>ìŠ¬ë¡¯ ${idx+1}</span><span class="slot-status idle">ëŒ€ê¸°</span></div>
        <div class="slot-row-note">ì„ íƒ í’ˆì§ˆë¡œ ì¡°ë¦½ ì‹œì‘ ê°€ëŠ¥</div>
        <div class="slot-row-note">ğŸ’° ${costStr}</div>
        <button class="slot-btn" onclick="startAssembly(${idx})" ${canStart?'':'disabled'}>ì¡°ë¦½ ì‹œì‘</button>
      </div>`;
    }
    const q = getQuality(job.qualityId);
    if (job.ready) {
      const reward = getMoonstoneRewardForQuality(q.id);
      return `<div class="slot-item">
        <div class="slot-header"><span>ìŠ¬ë¡¯ ${idx+1} Â· ${q.icon} ${q.name}</span><span class="slot-status ready">ë°œì‚¬ ì¤€ë¹„ ì™„ë£Œ</span></div>
        <div class="slot-row-note">ì˜ˆìƒ ë¬¸ìŠ¤í†¤ ë³´ìƒ +${reward}</div>
        <button class="slot-btn launch" onclick="launchFromSlot(${idx})">ğŸŒ™ ë°œì‚¬ ì‹¤í–‰</button>
      </div>`;
    }
    const remain = Math.max(0, Math.floor((job.endAt - Date.now()) / 1000));
    const total = Math.max(1, Math.floor((job.endAt - job.startAt) / 1000));
    const p = Math.min(100, ((total - remain) / total) * 100);
    return `<div class="slot-item">
      <div class="slot-header"><span>ìŠ¬ë¡¯ ${idx+1} Â· ${q.icon} ${q.name}</span><span class="slot-status busy">ì¡°ë¦½ ì¤‘ ${fmtTime(remain)}</span></div>
      <div class="progress-bar"><div class="progress-fill" style="width:${p}%"></div></div>
    </div>`;
  }).join('');
  document.getElementById('assembly-slots').innerHTML = slotsHtml;
}
function renderUpgrades() {
  const html = UPGRADES.map(u => {
    const purchased = gs.upgrades[u.id];
    const reqMet = !u.req || gs.upgrades[u.req];
    const affordable = canAfford(u.cost);
    const costStr = Object.entries(u.cost).map(([r,v])=>`${RESOURCES.find(x=>x.id===r)?.icon||''}${fmt(v)}`).join(' ');
    if (!reqMet && !purchased) return '';
    return `<div class="upgrade-item ${purchased?'purchased':''}">
      <div class="upgrade-header">
        <div class="upgrade-name">${u.icon} ${u.name}</div>
        ${purchased?'<span style="color:var(--accent-green);font-size:0.75rem">âœ…</span>':''}
      </div>
      <div class="upgrade-desc">${u.desc}</div>
      ${!purchased?`<div class="upgrade-cost">ğŸ”¬ ${costStr}</div>`:''}
      ${!purchased?`<button class="upg-btn" onclick="buyUpgrade('${u.id}')" ${affordable?'':'disabled'}>ì—°êµ¬</button>`:''}
    </div>`;
  }).join('');
  document.getElementById('upgrades-list').innerHTML = html;
}
function renderMoonstone() {
  const disp = document.getElementById('moonstone-display');
  if (gs.moonstone > 0 || gs.launches > 0) {
    disp.style.display = 'inline-flex';
    document.getElementById('moonstone-count').textContent = gs.moonstone;
    document.getElementById('moonstone-bonus').textContent = (gs.moonstone*5).toFixed(0);
  }
}
function renderAll() {
  ensureAssemblyState();
  renderResources();
  renderBuildings();
  renderParts();
  renderScienceSummary();
  renderAssembly();
  renderUpgrades();
  renderMoonstone();
  renderSoundToggle();
}

// ==================== SAVE / LOAD ====================
function migrateSave(rawSave) {
  const src = rawSave || {};
  const version = Number(src.saveVersion || 1);
  let migrated = { ...src };

  if (version < 2) {
    const nextGs = migrated.gs || {};
    const nextBuildings = { ...(nextGs.buildings || {}) };
    if (typeof nextBuildings.launchPad !== 'number') nextBuildings.launchPad = 0;
    const nextAssembly = nextGs.assembly && typeof nextGs.assembly === 'object'
      ? nextGs.assembly
      : { selectedQuality: 'proto', jobs: [] };

    migrated = {
      ...migrated,
      gs: {
        ...nextGs,
        buildings: nextBuildings,
        assembly: {
          selectedQuality: nextAssembly.selectedQuality || 'proto',
          jobs: Array.isArray(nextAssembly.jobs) ? nextAssembly.jobs : []
        }
      },
      reliabilityBonus: Number(migrated.reliabilityBonus || 0),
      slotBonus: Number(migrated.slotBonus || 0),
      saveVersion: 2
    };
  }

  if (!migrated.saveVersion) migrated.saveVersion = SAVE_VERSION;
  return migrated;
}

function saveGame() {
  const save = {
    saveVersion: SAVE_VERSION,
    gs, prodMult, globalMult, partCostMult, fusionBonus, reliabilityBonus, slotBonus,
    lastSave: Date.now()
  };
  localStorage.setItem('moonIdle_v1', JSON.stringify(save));
}
function loadGame() {
  try {
    const raw = localStorage.getItem('moonIdle_v1');
    if (!raw) return;
    const save = migrateSave(JSON.parse(raw));
    Object.assign(gs, save.gs);
    if (!gs.buildings.launchPad) gs.buildings.launchPad = 0;
    if (!gs.assembly) gs.assembly = { selectedQuality:'proto', jobs:[] };
    if (!gs.settings) gs.settings = { sound: true };
    if (typeof gs.settings.sound !== 'boolean') gs.settings.sound = true;
    Object.assign(prodMult, save.prodMult||{});
    globalMult = save.globalMult||1;
    partCostMult = save.partCostMult||1;
    fusionBonus = save.fusionBonus||0;
    reliabilityBonus = save.reliabilityBonus||0;
    slotBonus = save.slotBonus||0;
    ensureAssemblyState();
    // re-apply upgrade effects for multipliers (they're stored directly)
    // offline progress
    calcOffline();
  } catch(e) { console.warn('Save load failed', e); }
}

// ==================== STARS ====================
function createStars() {
  const container = document.getElementById('stars');
  for (let i=0; i<150; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const size = Math.random()*2.5+0.5;
    s.style.cssText = `
      width:${size}px; height:${size}px;
      left:${Math.random()*100}%;
      top:${Math.random()*100}%;
      --dur:${2+Math.random()*4}s;
      --delay:${Math.random()*4}s;
      opacity:${0.2+Math.random()*0.8};
    `;
    container.appendChild(s);
  }
}

// ==================== INIT ====================
createStars();
loadGame();
renderAll();

// Game loop
setInterval(() => { tick(); }, 200);
// UI update loop
setInterval(() => { renderAll(); }, 500);
// Auto save
setInterval(() => { saveGame(); }, 30000);

// Page visibility - pause tick when hidden
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    calcOffline();
  }
});
</script>
</body>
</html>
