<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MOON IDLE â€” ë‹¬ íƒì‚¬ ë¡œì¼“ ì œì‘ì†Œ</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
/* ==================== v7 CRT DESIGN TOKENS ==================== */
:root {
  --bg:         #010800;
  --panel-bg:   #020d04;
  --green:      #00e676;
  --green-dim:  #1a5c34;
  --green-mid:  #00994d;
  --amber:      #ffab00;
  --red:        #ff1744;
  --font:       'Share Tech Mono', monospace;
  --border:     1px solid #1a5c34;
  --glow:       0 0 6px #00e67680;
  --glow-strong: 0 0 12px #00e676, 0 0 24px #00e67650;
}

/* ==================== RESET & BASE ==================== */
*{box-sizing:border-box;margin:0;padding:0;border-radius:0!important;}
html,body{min-height:100vh;}
body{
  font-family:var(--font);
  background:var(--bg);
  color:var(--green);
  font-size:15px;
  overflow-x:hidden;
  animation:crt-flicker 8s linear infinite;
}

/* CRT SCANLINES */
body::before{
  content:'';
  position:fixed;inset:0;
  background:repeating-linear-gradient(
    0deg,
    transparent,transparent 2px,
    rgba(0,0,0,0.18) 2px,rgba(0,0,0,0.18) 4px
  );
  pointer-events:none;z-index:9999;
}
/* CRT VIGNETTE */
body::after{
  content:'';
  position:fixed;inset:0;
  background:radial-gradient(ellipse at center,transparent 60%,rgba(0,0,0,0.7) 100%);
  pointer-events:none;z-index:9998;
}
@keyframes crt-flicker{
  0%,92%,94%,97%,100%{opacity:1;}
  93%{opacity:0.85;}
  96%{opacity:0.90;}
}

/* ==================== SCROLLBAR ==================== */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--green-dim);}

/* ==================== TEXT GLOW ==================== */
.glow{text-shadow:var(--glow);}
.glow-strong{text-shadow:var(--glow-strong);}

/* ==================== TITLE SCREEN ==================== */
#title-screen{
  position:fixed;inset:0;
  background:var(--bg);
  z-index:5000;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:20px;
  transition:opacity 0.8s ease;
}
#title-screen.fade-out{opacity:0;pointer-events:none;}
.title-logo{
  font-size:clamp(24px,5vw,48px);
  letter-spacing:16px;
  color:var(--green);
  text-shadow:var(--glow-strong);
  margin-bottom:8px;
  text-align:center;
}
.title-subtitle{
  font-size:13px;
  letter-spacing:4px;
  color:var(--green-mid);
  margin-bottom:32px;
  text-align:center;
}
.boot-log{
  width:100%;max-width:600px;
  height:200px;
  overflow:hidden;
  border:var(--border);
  background:var(--panel-bg);
  padding:12px;
  font-size:13px;
  color:var(--green-mid);
  margin-bottom:24px;
}
.boot-line{
  display:block;
  margin-bottom:2px;
  opacity:0;
  animation:boot-appear 0.1s forwards;
}
@keyframes boot-appear{to{opacity:1;}}
.title-save-strip{
  width:100%;max-width:600px;
  border:var(--border);
  background:var(--panel-bg);
  padding:10px 16px;
  font-size:13px;
  color:var(--green-mid);
  margin-bottom:20px;
  display:flex;gap:24px;flex-wrap:wrap;
}
.title-save-strip span{color:var(--green);}
.title-btns{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
.title-btn{
  background:none;
  border:2px solid var(--green-dim);
  color:var(--green);
  font-family:var(--font);
  font-size:15px;
  letter-spacing:3px;
  padding:10px 28px;
  cursor:pointer;
  transition:all 0.15s;
  text-transform:uppercase;
}
.title-btn:hover{
  border-color:var(--green);
  text-shadow:var(--glow-strong);
  box-shadow:var(--glow-strong);
}
.title-btn.primary{border-color:var(--amber);color:var(--amber);}
.title-btn.primary:hover{box-shadow:0 0 12px #ffab00,0 0 24px #ffab0050;}

/* ==================== MAIN APP ==================== */
#app{
  display:none;
  max-width:1200px;
  margin:0 auto;
  padding:0 8px 20px;
}
#app.visible{display:block;}

/* ==================== RESOURCE BAR ==================== */
#res-bar{
  position:sticky;top:0;z-index:100;
  background:var(--bg);
  border-bottom:var(--border);
  padding:6px 8px;
  display:flex;align-items:center;justify-content:space-between;
  gap:6px;flex-wrap:wrap;
}
.res-bar-inner{
  display:flex;gap:6px;flex-wrap:wrap;align-items:center;flex:1;
}
.res-cell{
  border:var(--border);
  padding:3px 8px;
  font-size:13px;
  color:var(--green);
  white-space:nowrap;
  text-shadow:var(--glow);
}
.res-cell .rate{color:var(--green-mid);font-size:12px;}
.res-cell .ms{color:var(--amber);}
.res-bar-right{display:flex;align-items:center;gap:8px;}
#sound-btn{
  background:none;
  border:var(--border);
  color:var(--green-mid);
  font-family:var(--font);
  font-size:13px;
  padding:3px 10px;
  cursor:pointer;
  letter-spacing:1px;
  text-transform:uppercase;
}
#sound-btn:hover{color:var(--green);border-color:var(--green);}

/* ==================== NAV TABS ==================== */
#nav-tabs{
  display:flex;
  border-bottom:var(--border);
  margin-bottom:0;
}
.nav-tab{
  flex:1;
  background:none;
  border:none;
  border-bottom:2px solid transparent;
  border-right:var(--border);
  color:var(--green-dim);
  font-family:var(--font);
  font-size:14px;
  letter-spacing:1px;
  padding:8px 4px;
  cursor:pointer;
  text-transform:uppercase;
  transition:all 0.15s;
  text-align:center;
}
.nav-tab:last-child{border-right:none;}
.nav-tab:hover{color:var(--green);text-shadow:var(--glow);}
.nav-tab.active{
  color:var(--green);
  border-bottom-color:var(--green);
  text-shadow:var(--glow-strong);
  background:rgba(0,230,118,0.04);
}

/* ==================== TAB PANES ==================== */
.tab-pane{display:none;padding:12px 0;}
.tab-pane.active{display:block;}

/* ==================== PANELS ==================== */
.panel{
  background:var(--panel-bg);
  border:var(--border);
  padding:10px 12px;
  margin-bottom:10px;
}
.panel-header{
  font-size:13px;
  letter-spacing:3px;
  color:var(--green);
  text-transform:uppercase;
  border-bottom:var(--border);
  padding-bottom:6px;
  margin-bottom:8px;
  text-shadow:var(--glow);
}
.panel-header::before{content:'// ';}

/* ==================== BUTTONS ==================== */
.btn{
  background:none;
  border:2px solid var(--green-dim);
  color:var(--green);
  font-family:var(--font);
  font-size:14px;
  letter-spacing:2px;
  padding:6px 14px;
  cursor:pointer;
  text-transform:uppercase;
  transition:all 0.12s;
  display:inline-block;
}
.btn:hover:not(:disabled){
  border-color:var(--green);
  text-shadow:var(--glow);
}
.btn:disabled{opacity:0.3;cursor:not-allowed;}
.btn-amber{border-color:var(--amber);color:var(--amber);}
.btn-amber:hover:not(:disabled){box-shadow:0 0 8px #ffab00;}
.btn-red{border-color:var(--red);color:var(--red);}
.btn-sm{font-size:12px;padding:3px 8px;letter-spacing:1px;}
.btn-full{display:block;width:100%;text-align:center;}

/* ==================== PROGRESS BAR ==================== */
.prog-wrap{
  border:1px solid var(--green-dim);
  height:8px;
  background:var(--bg);
  overflow:hidden;
  margin:4px 0;
}
.prog-fill{
  height:100%;
  background:var(--green-mid);
  transition:width 0.3s;
}
.prog-fill.amber{background:var(--amber);}
.prog-fill.red{background:var(--red);}

/* ==================== OFFLINE BANNER ==================== */
#offline-banner{
  display:none;
  background:rgba(255,171,0,0.08);
  border:1px solid var(--amber);
  color:var(--amber);
  padding:6px 12px;
  font-size:13px;
  margin-bottom:8px;
}

/* ==================== NOTIFICATIONS ==================== */
#notif{
  position:fixed;bottom:16px;right:16px;
  z-index:8000;
  display:flex;flex-direction:column;gap:6px;
  pointer-events:none;
}
.notif-item{
  background:var(--panel-bg);
  border:1px solid var(--green-dim);
  color:var(--green);
  font-size:13px;
  padding:7px 14px;
  text-shadow:var(--glow);
  animation:notif-in 0.2s ease,notif-out 0.4s ease 2.6s forwards;
  max-width:320px;
}
.notif-item.amber{border-color:var(--amber);color:var(--amber);}
.notif-item.red{border-color:var(--red);color:var(--red);}
@keyframes notif-in{from{opacity:0;transform:translateX(40px);}to{opacity:1;transform:none;}}
@keyframes notif-out{to{opacity:0;transform:translateX(40px);}}

/* ==================== TAB 1: PRODUCTION HUB ==================== */
.prod-status-line{
  font-size:13px;color:var(--green-mid);
  margin-bottom:8px;
  border-bottom:var(--border);
  padding-bottom:6px;
}
.prod-world-wrap{
  overflow-x:auto;
  border:var(--border);
  padding:10px;
  background:var(--bg);
  margin-bottom:10px;
}
.prod-world{
  min-width:2400px;
  display:flex;
  gap:16px;
  align-items:flex-end;
  padding:8px 4px;
  font-size:13px;
  line-height:1.3;
}
.building-ascii-wrap{
  position:relative;
  display:inline-block;
  cursor:pointer;
  flex-shrink:0;
}
.building-ascii{
  font-size:12px;
  line-height:1.25;
  color:var(--green-mid);
  white-space:pre;
  transition:color 0.15s;
  text-shadow:none;
}
.building-ascii-wrap:hover .building-ascii{
  color:var(--green);
  text-shadow:var(--glow);
}
.building-ascii-wrap .bld-count-badge{
  position:absolute;top:-4px;right:-4px;
  background:var(--green-dim);
  color:var(--green);
  font-size:11px;
  padding:0 4px;
  min-width:18px;
  text-align:center;
  border:1px solid var(--green);
}
.bld-hover-overlay{
  display:none;
  position:absolute;
  top:0;left:100%;
  z-index:200;
  background:var(--panel-bg);
  border:1px solid var(--green);
  padding:8px 12px;
  white-space:pre;
  font-size:12px;
  line-height:1.5;
  color:var(--green);
  min-width:240px;
  text-shadow:var(--glow);
  pointer-events:none;
}
.building-ascii-wrap:hover .bld-hover-overlay{display:block;}
.bld-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:8px;
}
.bld-card{
  border:var(--border);
  background:var(--panel-bg);
  padding:8px 10px;
}
.bld-card-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.bld-name{font-size:14px;color:var(--green);letter-spacing:1px;}
.bld-cnt{color:var(--amber);font-size:13px;}
.bld-desc{font-size:12px;color:var(--green-mid);margin-bottom:6px;}
.bld-rate{font-size:12px;color:var(--green-mid);margin-bottom:4px;}
.bld-cost{font-size:12px;color:var(--amber);margin-bottom:6px;}

/* ==================== TAB 2: RESEARCH ==================== */
.upg-tree{
  font-size:13px;
  line-height:1.6;
  overflow-x:auto;
}
.upg-tree-row{
  display:flex;gap:16px;margin-bottom:4px;flex-wrap:wrap;
}
.upg-node{
  border:1px solid var(--green-dim);
  background:var(--panel-bg);
  padding:8px 12px;
  cursor:pointer;
  min-width:180px;
  transition:all 0.12s;
  position:relative;
}
.upg-node.available{border-color:var(--amber);color:var(--amber);}
.upg-node.purchased{border-color:var(--green-dim);color:var(--green-dim);cursor:default;}
.upg-node.purchased .upg-node-name::after{content:' [OK]';}
.upg-node.locked{border-color:var(--bg);color:#0e2a18;cursor:not-allowed;}
.upg-node:hover:not(.purchased):not(.locked){border-color:var(--green);color:var(--green);text-shadow:var(--glow);}
.upg-node-name{font-size:13px;letter-spacing:1px;margin-bottom:3px;text-transform:uppercase;}
.upg-node-desc{font-size:11px;color:var(--green-mid);}
.upg-node.available .upg-node-desc{color:var(--amber);}
.upg-node-cost{font-size:11px;margin-top:4px;}
.upg-connector{
  font-size:12px;color:var(--green-dim);
  align-self:center;
  user-select:none;
}
.upg-tree-section{margin-bottom:16px;}
.upg-tree-section-title{
  font-size:11px;letter-spacing:3px;color:var(--green-mid);
  text-transform:uppercase;border-bottom:var(--border);
  padding-bottom:4px;margin-bottom:8px;
}
.upg-tree-section-title::before{content:'// ';}

/* ==================== TAB 3: ASSEMBLY ==================== */
.assembly-layout{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
@media(max-width:700px){.assembly-layout{grid-template-columns:1fr;}}
.rocket-art-wrap{
  border:var(--border);
  background:var(--bg);
  padding:12px;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.rocket-art{
  font-size:12px;
  line-height:1.3;
  white-space:pre;
  text-align:left;
  font-family:var(--font);
  color:var(--green-mid);
}
.rocket-art .r-nose{color:var(--green-dim);}
.rocket-art .r-payload{color:var(--green-dim);}
.rocket-art .r-avionics{color:var(--green-dim);}
.rocket-art .r-engine{color:var(--green-dim);}
.rocket-art .r-exhaust{color:var(--green-dim);}

.rocket-art .r-nose.done{color:var(--green);text-shadow:var(--glow);}
.rocket-art .r-payload.done{color:var(--green);text-shadow:var(--glow);}
.rocket-art .r-avionics.done{color:var(--green);text-shadow:var(--glow);}
.rocket-art .r-engine.done{color:var(--green);text-shadow:var(--glow);}
.rocket-art .r-exhaust.done{color:var(--amber);text-shadow:0 0 6px #ffab0080;}

.quality-selector{
  display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;
}
.qual-btn{
  background:none;
  border:1px solid var(--green-dim);
  color:var(--green-mid);
  font-family:var(--font);
  font-size:12px;
  padding:4px 10px;
  cursor:pointer;
  text-transform:uppercase;
  letter-spacing:1px;
  transition:all 0.12s;
}
.qual-btn.active{
  border-color:var(--amber);
  color:var(--amber);
  text-shadow:0 0 6px #ffab0080;
}
.qual-btn:hover:not(.active){border-color:var(--green-dim);color:var(--green);}

.parts-list-item{
  display:flex;justify-content:space-between;align-items:center;
  border-bottom:1px solid #0e2a18;
  padding:5px 0;
  font-size:13px;
  gap:8px;
}
.part-done{color:var(--green);text-shadow:var(--glow);}
.part-pending{color:var(--green-dim);}
.part-check{font-size:12px;color:var(--green-mid);min-width:14px;}

.slot-card{
  border:var(--border);
  background:var(--panel-bg);
  padding:8px 10px;
  margin-bottom:8px;
}
.slot-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
.slot-title{font-size:13px;color:var(--green);letter-spacing:1px;}
.slot-state{font-size:12px;}
.slot-state.idle{color:var(--green-mid);}
.slot-state.busy{color:var(--amber);}
.slot-state.ready{color:var(--green);text-shadow:var(--glow);}

.science-box{
  border:var(--border);
  background:var(--bg);
  padding:8px 10px;
  font-size:12px;
  color:var(--green-mid);
  margin-top:8px;
  line-height:1.6;
}
.science-box .val{color:var(--green);}
.science-box .ms-val{color:var(--amber);}

/* ==================== TAB 4: LAUNCH CONTROL ==================== */
.launch-layout{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
@media(max-width:700px){.launch-layout{grid-template-columns:1fr;}}

.ready-list{font-size:13px;color:var(--green-mid);line-height:1.8;}
.ready-slot-row{
  display:flex;justify-content:space-between;align-items:center;
  border-bottom:1px solid #0e2a18;
  padding:5px 0;
  gap:8px;
}

.telemetry-wrap{
  border:var(--border);
  background:var(--bg);
  padding:10px 12px;
  font-size:13px;
  min-height:160px;
}
.telem-line{
  display:flex;align-items:center;gap:8px;
  padding:3px 0;
  border-bottom:1px solid #0a1a0a;
  color:var(--green-mid);
}
.telem-time{color:var(--green-mid);min-width:55px;font-size:12px;}
.telem-event{min-width:160px;color:var(--green);text-transform:uppercase;font-size:12px;}
.telem-bar{flex:1;height:6px;border:1px solid var(--green-dim);position:relative;}
.telem-bar-fill{height:100%;background:var(--green-mid);transition:width 0.5s;}
.telem-pct{color:var(--green);font-size:12px;min-width:36px;text-align:right;}

.launch-result{
  display:none;
  border:1px solid var(--amber);
  background:rgba(255,171,0,0.05);
  padding:12px;
  font-size:13px;
  color:var(--amber);
  margin-top:10px;
}
.launch-result.show{display:block;}
.launch-result-title{
  font-size:15px;letter-spacing:3px;text-transform:uppercase;
  text-shadow:0 0 12px #ffab00;margin-bottom:8px;
}
.launch-result-stats{
  display:grid;grid-template-columns:1fr 1fr;gap:4px;
  font-size:12px;margin-bottom:10px;
}
.launch-result-stat-lbl{color:var(--green-mid);}
.launch-result-stat-val{color:var(--amber);}

.launch-anim-wrap{
  text-align:center;
  padding:10px;
  min-height:120px;
  position:relative;
  overflow:hidden;
}
.launch-rocket-ascii{
  font-size:11px;
  white-space:pre;
  color:var(--green);
  display:inline-block;
  transition:transform 1.5s ease-in;
  position:relative;
}
.launch-rocket-ascii.launching{
  animation:rocket-launch 3s ease-in forwards;
}
@keyframes rocket-launch{
  0%{transform:translateY(0);}
  100%{transform:translateY(-400px);}
}
.exhaust-anim{
  font-size:11px;
  white-space:pre;
  color:var(--amber);
  text-shadow:0 0 6px #ffab00;
  display:inline-block;
  animation:exhaust-flicker 0.15s step-start infinite;
}
@keyframes exhaust-flicker{
  0%{opacity:1;}50%{opacity:0.4;}100%{opacity:1;}
}

/* ==================== TAB 5: MISSION PROGRESS ==================== */
.phase-row{
  display:flex;align-items:center;gap:10px;
  padding:6px 0;
  border-bottom:1px solid #0e2a18;
  font-size:13px;
}
.phase-name{min-width:200px;color:var(--green-mid);text-transform:uppercase;font-size:12px;}
.phase-bar-wrap{flex:1;height:8px;border:1px solid var(--green-dim);background:var(--bg);}
.phase-bar-fill{height:100%;background:var(--green-mid);transition:width 0.5s;}
.phase-bar-fill.done{background:var(--green);}
.phase-status{min-width:80px;font-size:12px;text-align:right;color:var(--green-mid);}
.phase-status.done{color:var(--green);}
.phase-status.locked{color:#0e2a18;}

.history-table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
  margin-top:6px;
}
.history-table th{
  background:#021508;
  color:var(--green-mid);
  text-align:left;
  padding:5px 8px;
  border:var(--border);
  letter-spacing:1px;
  font-weight:normal;
  text-transform:uppercase;
}
.history-table td{
  padding:4px 8px;
  border:1px solid #0e2a18;
  color:var(--green);
}
.history-table tr:hover td{background:rgba(0,230,118,0.04);}

.prestige-panel{
  border:1px solid var(--amber);
  background:rgba(255,171,0,0.04);
  padding:12px;
  margin-top:10px;
}
.prestige-panel .panel-header{
  color:var(--amber);
  border-bottom-color:var(--amber);
}
.prestige-panel .panel-header::before{content:'// ';}
.prestige-stat{
  font-size:13px;color:var(--amber);
  margin-bottom:6px;line-height:1.6;
}

/* ==================== LAUNCH OVERLAY ==================== */
#launch-overlay{
  display:none;
  position:fixed;inset:0;
  background:rgba(1,8,0,0.97);
  z-index:7000;
  align-items:center;justify-content:center;
  flex-direction:column;
  text-align:center;
  padding:20px;
}
#launch-overlay.show{display:flex;}
.lo-title{
  font-size:24px;letter-spacing:8px;text-transform:uppercase;
  color:var(--amber);text-shadow:0 0 20px #ffab00;
  margin-bottom:12px;
}
.lo-rocket{
  font-size:11px;white-space:pre;
  color:var(--amber);text-shadow:0 0 6px #ffab0080;
  margin-bottom:12px;
  animation:rocket-launch 4s ease-in forwards;
}
.lo-stats{
  font-size:14px;color:var(--green);
  margin-bottom:16px;line-height:2;
  text-shadow:var(--glow);
}
.lo-ms{font-size:18px;color:var(--amber);letter-spacing:3px;margin-bottom:20px;}
.lo-btns{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;}

/* ==================== MISC ==================== */
.sep{border:none;border-top:var(--border);margin:8px 0;}
.label-sm{font-size:11px;color:var(--green-mid);letter-spacing:2px;text-transform:uppercase;}
.val-green{color:var(--green);text-shadow:var(--glow);}
.val-amber{color:var(--amber);}
.val-red{color:var(--red);}
.cursor-blink::after{content:'_';animation:blink 1s step-start infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}
</style>
</head>
<body>

<!-- ==================== TITLE SCREEN ==================== -->
<div id="title-screen">
  <div class="title-logo glow-strong">MOON IDLE</div>
  <div class="title-subtitle">ë‹¬ íƒì‚¬ ë¡œì¼“ ì œì‘ì†Œ / LUNAR EXPLORATION SIM</div>
  <div class="boot-log" id="boot-log"></div>
  <div class="title-save-strip" id="save-strip">
    <span>ì„¸ì´ë¸Œ ì—†ìŒ</span>
  </div>
  <div class="title-btns">
    <button class="title-btn primary" onclick="startNewGame()">ìƒˆ ê²Œì„</button>
    <button class="title-btn" id="continue-btn" onclick="continueGame()" style="display:none">ì´ì–´í•˜ê¸°</button>
    <button class="title-btn" onclick="openSettings()">ì„¤ì •</button>
  </div>
</div>

<!-- ==================== MAIN APP ==================== -->
<div id="app">
  <!-- RESOURCE BAR -->
  <div id="res-bar">
    <div class="res-bar-inner" id="res-bar-inner"></div>
    <div class="res-bar-right">
      <button id="sound-btn" onclick="toggleSound()">SND:ON</button>
    </div>
  </div>

  <!-- NAV TABS -->
  <div id="nav-tabs">
    <button class="nav-tab active" onclick="switchMainTab(0)">ìƒì‚° í—ˆë¸Œ</button>
    <button class="nav-tab" onclick="switchMainTab(1)">ì—°êµ¬ì†Œ</button>
    <button class="nav-tab" onclick="switchMainTab(2)">ì¡°ë¦½ë™</button>
    <button class="nav-tab" onclick="switchMainTab(3)">ë°œì‚¬ í†µì œ</button>
    <button class="nav-tab" onclick="switchMainTab(4)">ë¯¸ì…˜ í˜„í™©</button>
  </div>

  <!-- OFFLINE BANNER -->
  <div id="offline-banner"></div>

  <!-- ===== TAB 0: PRODUCTION HUB ===== -->
  <div class="tab-pane active" id="pane-0">
    <div class="panel">
      <div class="panel-header">ìƒì‚° í—ˆë¸Œ</div>
      <div class="prod-status-line" id="prod-status"></div>
      <!-- ASCII world -->
      <div class="prod-world-wrap">
        <div class="prod-world" id="prod-world"></div>
      </div>
      <!-- Building cards -->
      <div class="bld-grid" id="bld-grid"></div>
    </div>
  </div>

  <!-- ===== TAB 1: RESEARCH ===== -->
  <div class="tab-pane" id="pane-1">
    <div class="panel">
      <div class="panel-header">ì—°êµ¬ì†Œ â€” ì—…ê·¸ë ˆì´ë“œ íŠ¸ë¦¬</div>
      <div id="upg-tree-wrap"></div>
    </div>
  </div>

  <!-- ===== TAB 2: ASSEMBLY ===== -->
  <div class="tab-pane" id="pane-2">
    <div class="panel">
      <div class="panel-header">ë¡œì¼“ ì¡°ë¦½ë™</div>
      <div class="assembly-layout">
        <!-- LEFT: ASCII rocket + parts -->
        <div>
          <div class="rocket-art-wrap">
            <div id="rocket-art-display"></div>
          </div>
          <div class="panel" style="margin-top:8px;">
            <div class="panel-header">ë¶€í’ˆ í˜„í™©</div>
            <div id="parts-checklist"></div>
          </div>
          <div class="science-box" id="science-box"></div>
        </div>
        <!-- RIGHT: quality + slots -->
        <div>
          <div class="panel">
            <div class="panel-header">í’ˆì§ˆ ë“±ê¸‰</div>
            <div class="quality-selector" id="quality-selector"></div>
          </div>
          <div class="panel" style="margin-top:8px;">
            <div class="panel-header">ì¡°ë¦½ ìŠ¬ë¡¯</div>
            <div id="assembly-slots-wrap"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== TAB 3: LAUNCH CONTROL ===== -->
  <div class="tab-pane" id="pane-3">
    <div class="panel">
      <div class="panel-header">ë°œì‚¬ í†µì œ</div>
      <div class="launch-layout">
        <div>
          <div class="panel">
            <div class="panel-header">ë°œì‚¬ ì¤€ë¹„ ëª©ë¡</div>
            <div id="ready-list-wrap"></div>
          </div>
          <div class="launch-result" id="launch-result">
            <div class="launch-result-title">ë°œì‚¬ ì„±ê³µ</div>
            <div class="launch-result-stats" id="lr-stats"></div>
            <div id="lr-ms" style="color:var(--amber);font-size:14px;margin-bottom:8px;"></div>
          </div>
        </div>
        <div>
          <div class="panel">
            <div class="panel-header">ë°œì‚¬ ì‹œí€€ìŠ¤</div>
            <div class="launch-anim-wrap" id="launch-anim-wrap">
              <div style="color:var(--green-mid);font-size:12px;">// ë°œì‚¬ ëŒ€ê¸° ì¤‘</div>
            </div>
            <div id="telem-wrap"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== TAB 4: MISSION PROGRESS ===== -->
  <div class="tab-pane" id="pane-4">
    <div class="panel">
      <div class="panel-header">ë¯¸ì…˜ ì§„í–‰ í˜„í™©</div>
      <div id="phase-progress-wrap"></div>
    </div>
    <div class="panel">
      <div class="panel-header">ë°œì‚¬ ê¸°ë¡</div>
      <div id="history-wrap"></div>
    </div>
    <div id="prestige-wrap"></div>
  </div>
</div>

<!-- ==================== LAUNCH OVERLAY ==================== -->
<div id="launch-overlay">
  <div class="lo-title">// ë‹¬ íƒì‚¬ ì„±ê³µ</div>
  <pre class="lo-rocket" id="lo-rocket-art"></pre>
  <div class="lo-stats" id="lo-stats"></div>
  <div class="lo-ms" id="lo-ms"></div>
  <div class="lo-btns">
    <button class="btn btn-amber" onclick="confirmLaunch()">ë¬¸ìŠ¤í†¤ íšë“ í›„ ì¬ì‹œì‘</button>
    <button class="btn" onclick="closeLaunchOverlay()">ê³„ì† ì§„í–‰</button>
  </div>
</div>

<!-- NOTIFICATIONS -->
<div id="notif"></div>

<script>
// ============================================================
//  GAME DATA
// ============================================================
const RESOURCES = [
  { id:'money',       name:'ëˆ',       symbol:'â‚©',  color:'var(--amber)' },
  { id:'metal',       name:'ê¸ˆì†',     symbol:'Fe', color:'var(--green)' },
  { id:'fuel',        name:'ì—°ë£Œ',     symbol:'LOX',color:'var(--green)' },
  { id:'electronics', name:'ì „ìë¶€í’ˆ', symbol:'PCB',color:'var(--green)' },
  { id:'research',    name:'ì—°êµ¬',     symbol:'RP', color:'var(--green-mid)' },
];

const BUILDINGS = [
  { id:'ops_center',   name:'ìš´ì˜ ì„¼í„°',      icon:'[OPS]', produces:'money',       baseRate:20,  baseCost:{metal:50},                          desc:'ìˆ˜ìµ ì°½ì¶œ í—ˆë¸Œ' },
  { id:'supply_depot', name:'ë³´ê¸‰ ì°½ê³ ',      icon:'[DEP]', produces:'money',       baseRate:60,  baseCost:{metal:200,electronics:50},           desc:'ë¬¼ë¥˜ ìˆ˜ìµ' },
  { id:'mine',         name:'ì² ê´‘ì„ ì±„êµ´ê¸°',  icon:'[MIN]', produces:'metal',       baseRate:1.2, baseCost:{money:100},                          desc:'ê¸°ë³¸ ê¸ˆì† ìƒì‚°' },
  { id:'extractor',    name:'ë³´í¬ì‚¬ì´íŠ¸ ì¶”ì¶œê¸°',icon:'[EXT]',produces:'metal',      baseRate:3.5, baseCost:{money:500,metal:200},                 desc:'ê³ ê¸‰ ê¸ˆì† ì¶”ì¶œ' },
  { id:'refinery',     name:'ì—°ë£Œ ì •ì œì†Œ',    icon:'[REF]', produces:'fuel',        baseRate:0.8, baseCost:{money:300,metal:100},                 desc:'LOX/RP-1 ìƒì‚°' },
  { id:'cryo_plant',   name:'ê·¹ì €ì˜¨ í”ŒëœíŠ¸',  icon:'[CRY]', produces:'fuel',        baseRate:2.0, baseCost:{money:1000,metal:400,electronics:100},desc:'ê³ ìˆœë„ ê·¹ì €ì˜¨ ì—°ë£Œ' },
  { id:'elec_lab',     name:'ì „ìê³µí•™ ì—°êµ¬ì†Œ',icon:'[PCB]', produces:'electronics', baseRate:0.5, baseCost:{money:400,metal:150},                 desc:'íšŒë¡œ ë¶€í’ˆ ìƒì‚°' },
  { id:'fab_plant',    name:'ë°˜ë„ì²´ ê³µì¥',    icon:'[FAB]', produces:'electronics', baseRate:1.8, baseCost:{money:2000,metal:800,electronics:200}, desc:'ê³ ê¸‰ ë°˜ë„ì²´' },
  { id:'research_lab', name:'ì—°êµ¬ì†Œ',         icon:'[RSH]', produces:'research',    baseRate:0.4, baseCost:{money:500,electronics:100},            desc:'ê¸°ìˆ  ì—°êµ¬ í¬ì¸íŠ¸' },
  { id:'r_and_d',      name:'R&D ì„¼í„°',       icon:'[RND]', produces:'research',    baseRate:1.2, baseCost:{money:3000,electronics:500},           desc:'ê³ ê¸‰ ì—°êµ¬ ê°€ì†' },
  { id:'solar_array',  name:'íƒœì–‘ê´‘ ì–´ë ˆì´',  icon:'[SOL]', produces:'bonus',       baseRate:0.1, baseCost:{money:800,electronics:200},            desc:'ì „ì²´ ìƒì‚° +10%/ê°œ' },
  { id:'launch_pad',   name:'ë°œì‚¬ëŒ€',         icon:'[PAD]', produces:'bonus',       baseRate:0,   baseCost:{money:5000,metal:2000,electronics:500},desc:'ë°œì‚¬ ìŠ¬ë¡¯ +1' },
];

const PARTS = [
  { id:'engine',   name:'ì—”ì§„',      icon:'[ENG]', cost:{metal:80,  fuel:40,  electronics:20} },
  { id:'fueltank', name:'ì—°ë£Œ íƒ±í¬', icon:'[TNK]', cost:{metal:60,  fuel:60} },
  { id:'control',  name:'ì œì–´ ì‹œìŠ¤í…œ',icon:'[CTL]',cost:{electronics:80, research:30} },
  { id:'hull',     name:'ê¸°ì²´ ì„ ì²´', icon:'[HUL]', cost:{metal:100} },
  { id:'payload',  name:'íƒ‘ì¬ì²´',    icon:'[PLD]', cost:{electronics:40, research:50} },
];

const QUALITIES = [
  { id:'proto',    name:'PROTO-MK1', icon:'[P1]', costMult:1.0, timeSec:30,  ispBonus:0,  dryMassMult:1.0,  relBonus:0,  reuseBonus:0,  rewardMult:1.0 },
  { id:'standard', name:'STD-MK2',   icon:'[S2]', costMult:2.0, timeSec:60,  ispBonus:15, dryMassMult:0.95, relBonus:8,  reuseBonus:5,  rewardMult:1.5 },
  { id:'advanced', name:'ADV-MK3',   icon:'[A3]', costMult:4.0, timeSec:120, ispBonus:35, dryMassMult:0.88, relBonus:18, reuseBonus:12, rewardMult:2.5 },
  { id:'elite',    name:'ELITE-MK4', icon:'[E4]', costMult:8.0, timeSec:240, ispBonus:65, dryMassMult:0.78, relBonus:32, reuseBonus:22, rewardMult:4.5 },
];

const UPGRADES = [
  { id:'drill',      name:'ì •ë°€ ë“œë¦´',     icon:'[DRL]', cost:{research:50},                   req:null,        desc:'ê¸ˆì† ìƒì‚° +25%',            effect:()=>{ prodMult.metal=(prodMult.metal||1)*1.25; } },
  { id:'catalyst',   name:'ì´‰ë§¤ ì •ì œ',     icon:'[CAT]', cost:{research:80,fuel:100},           req:'drill',     desc:'ì—°ë£Œ ìƒì‚° +30%',            effect:()=>{ prodMult.fuel=(prodMult.fuel||1)*1.3; } },
  { id:'microchip',  name:'ë§ˆì´í¬ë¡œì¹©',    icon:'[MCH]', cost:{research:100,electronics:80},    req:null,        desc:'ì „ìë¶€í’ˆ +35%',             effect:()=>{ prodMult.electronics=(prodMult.electronics||1)*1.35; } },
  { id:'automation', name:'ìë™í™” ì‹œìŠ¤í…œ', icon:'[AUT]', cost:{research:200,electronics:200},   req:'microchip', desc:'ì „ì²´ ìƒì‚° Ã—1.5',            effect:()=>{ globalMult*=1.5; } },
  { id:'alloy',      name:'ê³ ê°•ë„ í•©ê¸ˆ',   icon:'[ALY]', cost:{research:150,metal:500},         req:'drill',     desc:'ë¶€í’ˆ ë¹„ìš© -20%',            effect:()=>{ partCostMult*=0.8; } },
  { id:'lightweight',name:'ê²½ëŸ‰ êµ¬ì¡°',     icon:'[LGT]', cost:{research:250,metal:800},         req:'alloy',     desc:'ê±´ì¡°ì§ˆëŸ‰ -10%, ì¬í™œìš© +8%', effect:()=>{ /* handled in getRocketScience */ } },
  { id:'fusion',     name:'í•µìœµí•© ì—”ì§„',   icon:'[FSN]', cost:{research:500,electronics:400},   req:'automation',desc:'Isp +22, ì¶”ë ¥ +120kN, ë¬¸ìŠ¤í†¤ +1', effect:()=>{ fusionBonus++; } },
  { id:'reliability',name:'ì‹ ë¢°ë„ ê°•í™”',   icon:'[REL]', cost:{research:300},                   req:'microchip', desc:'ë°œì‚¬ ì‹ ë¢°ë„ +15%',          effect:()=>{ reliabilityBonus+=15; } },
  { id:'multipad',   name:'ë³µìˆ˜ ë°œì‚¬ëŒ€',   icon:'[MUL]', cost:{research:400,metal:1000},        req:'alloy',     desc:'ì¡°ë¦½ ìŠ¬ë¡¯ +1',              effect:()=>{ slotBonus++; } },
];

// ============================================================
//  GAME STATE
// ============================================================
let gs = {
  res: { money:500, metal:0, fuel:0, electronics:0, research:0 },
  buildings: { ops_center:0, supply_depot:0, mine:0, extractor:0, refinery:0, cryo_plant:0, elec_lab:0, fab_plant:0, research_lab:0, r_and_d:0, solar_array:0, launch_pad:0 },
  parts: { engine:0, fueltank:0, control:0, hull:0, payload:0 },
  assembly: { selectedQuality:'proto', jobs:[] },
  upgrades: {},
  launches: 0,
  moonstone: 0,
  history: [],
  lastTick: Date.now(),
  settings: { sound: true },
  saveVersion: 2,
};
let prodMult = {};
let globalMult = 1;
let partCostMult = 1;
let fusionBonus = 0;
let reliabilityBonus = 0;
let slotBonus = 0;

let audioCtx = null;
let activeTab = 0;
let launchInProgress = false;
let pendingLaunchMs = 0;
let pendingLaunchData = null;

// ============================================================
//  HELPERS
// ============================================================
function fmt(n) {
  if (typeof n !== 'number' || isNaN(n)) return '0';
  if (n >= 1e9) return (n/1e9).toFixed(2)+'B';
  if (n >= 1e6) return (n/1e6).toFixed(2)+'M';
  if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
  return Math.floor(n).toString();
}
function fmtDec(n,d=1) {
  if (typeof n !== 'number' || isNaN(n)) return '0.0';
  if (n >= 1e6) return (n/1e6).toFixed(2)+'M';
  if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
  return n.toFixed(d);
}
function fmtTime(sec) {
  const s = Math.max(0, Math.floor(sec));
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const r = s%60;
  if (h>0) return `${h}h ${m}m`;
  if (m>0) return `${m}m ${r}s`;
  return `${r}s`;
}
function clamp(v,mn,mx){return Math.min(mx,Math.max(mn,v));}
function getQuality(qid){return QUALITIES.find(q=>q.id===qid)||QUALITIES[0];}
function getAssemblySlots(){return 1+gs.buildings.launch_pad+slotBonus;}
function ensureAssemblyState(){
  if(!gs.assembly) gs.assembly={selectedQuality:'proto',jobs:[]};
  if(!Array.isArray(gs.assembly.jobs)) gs.assembly.jobs=[];
  if(!gs.assembly.selectedQuality) gs.assembly.selectedQuality='proto';
  const slots=getAssemblySlots();
  while(gs.assembly.jobs.length<slots) gs.assembly.jobs.push(null);
  if(gs.assembly.jobs.length>slots) gs.assembly.jobs=gs.assembly.jobs.slice(0,slots);
}
function getMoonstoneMult(){return 1+gs.moonstone*0.05;}
function getSolarBonus(){return 1+gs.buildings.solar_array*0.1;}
function canAfford(cost){return Object.entries(cost).every(([r,v])=>(gs.res[r]||0)>=v);}
function spend(cost){Object.entries(cost).forEach(([r,v])=>{gs.res[r]-=v;});}
function getBuildingCost(bld){
  const cost={};
  Object.entries(bld.baseCost).forEach(([r,v])=>{cost[r]=Math.floor(v*Math.pow(1.15,gs.buildings[bld.id]));});
  return cost;
}
function getPartCost(part){
  const cost={};
  Object.entries(part.cost).forEach(([r,v])=>{cost[r]=Math.floor(v*partCostMult);});
  return cost;
}
function getProduction(){
  const prod={money:0,metal:0,fuel:0,electronics:0,research:0};
  BUILDINGS.forEach(b=>{
    if(b.produces==='bonus'||!(b.produces in prod)) return;
    const cnt=gs.buildings[b.id]||0;
    const rate=b.baseRate*cnt*(prodMult[b.produces]||1)*globalMult*getMoonstoneMult()*getSolarBonus();
    prod[b.produces]+=rate;
  });
  return prod;
}
function getTotalIncome(){
  const p=getProduction();
  return p.money;
}
function getTotalWorkers(){
  return Object.values(gs.buildings).reduce((a,b)=>a+b,0);
}
function getRocketScience(qualityId){
  const q=getQuality(qualityId);
  const isp=315+q.ispBonus+gs.buildings.elec_lab*1.2+(gs.upgrades.fusion?22:0);
  const dryMass=28*q.dryMassMult*(gs.upgrades.lightweight?0.9:1);
  const propMass=76+gs.buildings.refinery*0.1+gs.buildings.cryo_plant*0.2;
  const thrust=1450+gs.buildings.mine*0.8+(gs.upgrades.fusion?120:0);
  const m0=dryMass+propMass;
  const deltaV=isp*9.81*Math.log(m0/dryMass)/1000;
  const twr=thrust/(m0*9.81);
  const reliability=clamp(56+gs.buildings.research_lab*1.9+gs.buildings.elec_lab*0.8+reliabilityBonus+q.relBonus,0,99.5);
  const altitude=clamp(deltaV*22,0,400);
  return {deltaV,twr,reliability,altitude};
}
function getMoonstoneReward(qualityId){
  const sci=getRocketScience(qualityId);
  const q=getQuality(qualityId);
  return Math.max(1,Math.floor((sci.altitude/20)*q.rewardMult)+fusionBonus+Math.floor(gs.launches/4));
}
function getCostStr(cost){
  return Object.entries(cost).map(([r,v])=>{
    const res=RESOURCES.find(x=>x.id===r);
    return `${res?res.symbol:r}:${fmt(v)}`;
  }).join(' ');
}

// ============================================================
//  AUDIO
// ============================================================
function ensureAudio(){
  if(!audioCtx){
    const Ctx=window.AudioContext||window.webkitAudioContext;
    if(!Ctx) return null;
    audioCtx=new Ctx();
  }
  if(audioCtx.state==='suspended') audioCtx.resume();
  return audioCtx;
}
function playSfx(type='sine',freq=440,dur=0.08,vol=0.03,targetFreq=null){
  if(!gs.settings.sound) return;
  const ctx=ensureAudio();
  if(!ctx) return;
  const osc=ctx.createOscillator();
  const gain=ctx.createGain();
  const now=ctx.currentTime;
  osc.type=type;
  osc.frequency.setValueAtTime(freq,now);
  if(targetFreq) osc.frequency.exponentialRampToValueAtTime(targetFreq,now+dur);
  gain.gain.setValueAtTime(vol,now);
  gain.gain.exponentialRampToValueAtTime(0.0001,now+dur);
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.start(now);
  osc.stop(now+dur);
}
function playLaunchSfx(){
  if(!gs.settings.sound) return;
  playSfx('triangle',280,0.12,0.04,380);
  setTimeout(()=>playSfx('triangle',420,0.16,0.05,620),120);
  setTimeout(()=>playSfx('sawtooth',680,0.22,0.04,980),250);
}
function toggleSound(){
  gs.settings.sound=!gs.settings.sound;
  document.getElementById('sound-btn').textContent=gs.settings.sound?'SND:ON':'SND:OFF';
  document.getElementById('sound-btn').style.color=gs.settings.sound?'var(--green-mid)':'var(--red)';
  if(gs.settings.sound) playSfx('sine',640,0.06,0.03,720);
}

// ============================================================
//  NOTIFICATIONS
// ============================================================
function notify(msg,cls=''){
  const el=document.createElement('div');
  el.className='notif-item'+(cls?' '+cls:'');
  el.textContent=msg;
  document.getElementById('notif').appendChild(el);
  setTimeout(()=>el.remove(),3200);
}

// ============================================================
//  TAB SWITCHING
// ============================================================
function switchMainTab(idx){
  activeTab=idx;
  document.querySelectorAll('.nav-tab').forEach((t,i)=>t.classList.toggle('active',i===idx));
  document.querySelectorAll('.tab-pane').forEach((p,i)=>p.classList.toggle('active',i===idx));
  renderTab(idx);
}

// ============================================================
//  ACTIONS
// ============================================================
function buyBuilding(bid){
  const bld=BUILDINGS.find(b=>b.id===bid);
  if(!bld) return;
  const cost=getBuildingCost(bld);
  if(!canAfford(cost)){notify('ìì› ë¶€ì¡±',  'red');return;}
  spend(cost);
  gs.buildings[bid]=(gs.buildings[bid]||0)+1;
  notify(`${bld.icon} ${bld.name} ê±´ì„¤ ì™„ë£Œ (Ã—${gs.buildings[bid]})`);
  playSfx('triangle',360,0.08,0.03,520);
  renderTab(activeTab);
}
function craftPart(pid){
  const part=PARTS.find(p=>p.id===pid);
  if(!part) return;
  if(gs.parts[pid]){notify('ì´ë¯¸ ì œì‘ë¨');return;}
  const cost=getPartCost(part);
  if(!canAfford(cost)){notify('ìì› ë¶€ì¡±','red');return;}
  spend(cost);
  gs.parts[pid]=1;
  notify(`${part.icon} ${part.name} ì œì‘ ì™„ë£Œ`);
  playSfx('square',520,0.11,0.03,760);
  renderTab(activeTab);
}
function buyUpgrade(uid){
  const upg=UPGRADES.find(u=>u.id===uid);
  if(!upg||gs.upgrades[uid]) return;
  if(upg.req&&!gs.upgrades[upg.req]){notify('ì„ í–‰ ì—°êµ¬ í•„ìš”','red');return;}
  if(!canAfford(upg.cost)){notify('ì—°êµ¬ í¬ì¸íŠ¸ ë¶€ì¡±','red');return;}
  spend(upg.cost);
  gs.upgrades[uid]=true;
  upg.effect();
  notify(`${upg.icon} ${upg.name} ì—°êµ¬ ì™„ë£Œ`);
  playSfx('sawtooth',440,0.1,0.028,700);
  renderTab(activeTab);
}
function selectQuality(qid){
  gs.assembly.selectedQuality=qid;
  renderTab(2);
}
function startAssembly(slotIdx){
  ensureAssemblyState();
  if(!PARTS.every(p=>gs.parts[p.id])){notify('ë¶€í’ˆì„ ëª¨ë‘ ì œì‘í•˜ì„¸ìš”','red');return;}
  if(gs.assembly.jobs[slotIdx]){notify('ìŠ¬ë¡¯ì´ ì‚¬ìš© ì¤‘');return;}
  const q=getQuality(gs.assembly.selectedQuality);
  const cost=getAssemblyCost(q.id);
  if(!canAfford(cost)){notify('ìì› ë¶€ì¡±','red');return;}
  spend(cost);
  const now=Date.now();
  gs.assembly.jobs[slotIdx]={qualityId:q.id,startAt:now,endAt:now+q.timeSec*1000,ready:false};
  notify(`ìŠ¬ë¡¯ ${slotIdx+1}: ${q.name} ì¡°ë¦½ ì‹œì‘ (${fmtTime(q.timeSec)})`);
  playSfx('triangle',310,0.09,0.03,430);
  renderTab(activeTab);
}
function getAssemblyCost(qualityId){
  const q=getQuality(qualityId);
  const total={};
  PARTS.forEach(p=>{
    const c=getPartCost(p);
    Object.entries(c).forEach(([r,v])=>{total[r]=(total[r]||0)+Math.floor(v*q.costMult*0.32);});
  });
  return total;
}
function launchFromSlot(slotIdx){
  ensureAssemblyState();
  const job=gs.assembly.jobs[slotIdx];
  if(!job||!job.ready) return;
  const q=getQuality(job.qualityId);
  const sci=getRocketScience(q.id);
  const earned=getMoonstoneReward(q.id);
  gs.assembly.jobs[slotIdx]=null;
  gs.launches++;
  gs.history.push({
    no:gs.launches,
    quality:q.name,
    deltaV:sci.deltaV.toFixed(2),
    altitude:Math.floor(sci.altitude),
    reliability:sci.reliability.toFixed(1),
    date:`D+${gs.launches*2}`
  });
  pendingLaunchMs=earned;
  pendingLaunchData={q,sci,earned};
  showLaunchSequence(q,sci,earned,slotIdx);
}
function showLaunchSequence(q,sci,earned,slotIdx){
  // Switch to launch control tab and run telemetry
  switchMainTab(3);
  launchInProgress=true;
  const anim=document.getElementById('launch-anim-wrap');
  anim.innerHTML=`
<div id="launch-rocket-cnt">
<pre class="launch-rocket-ascii" id="launch-rocket-pre">        *
       /|\\
      / | \\
     /  |  \\
    / BETA  \\
   /__mk.2__\\
  |          |
  |  ENGINE  |
  |__________|</pre>
<pre class="exhaust-anim" id="exhaust-art" style="display:none;">  |   |   |
 /|\\ /|\\ /|\\
   |||||||||
    |||||||
     |||||</pre>
</div>`;
  const telemEl=document.getElementById('telem-wrap');
  telemEl.innerHTML='<div class="panel-header">í…”ë ˆë©”íŠ¸ë¦¬</div>';
  const steps=[
    {t:0,   label:'T+0  IGNITION',    pct:5},
    {t:800, label:'T+3  LIFTOFF',     pct:22},
    {t:1600,label:'T+8  MAX-Q',       pct:45},
    {t:2500,label:'T+14 MECO',        pct:72},
    {t:3400,label:'T+20 STAGE-2',     pct:88},
    {t:4000,label:`T+25 ALT:${Math.floor(sci.altitude)}KM`, pct:100},
  ];
  const telemDiv=document.createElement('div');
  telemDiv.className='telemetry-wrap';
  telemEl.appendChild(telemDiv);
  let exhaustShown=false;
  steps.forEach((step,i)=>{
    setTimeout(()=>{
      if(i===1){
        document.getElementById('exhaust-art').style.display='block';
        exhaustShown=true;
        document.getElementById('launch-rocket-pre').classList.add('launching');
      }
      const line=document.createElement('div');
      line.className='telem-line';
      line.innerHTML=`
        <span class="telem-time">${step.label.split(' ')[0]}</span>
        <span class="telem-event">${step.label.split(' ').slice(1).join(' ')}</span>
        <div class="telem-bar"><div class="telem-bar-fill" style="width:${step.pct}%"></div></div>
        <span class="telem-pct">${step.pct}%</span>`;
      telemDiv.appendChild(line);
      if(gs.settings.sound){
        playSfx('triangle',300+i*40,0.06,0.02,400+i*30);
      }
    },step.t);
  });
  setTimeout(()=>{
    launchInProgress=false;
    showLaunchOverlay(q,sci,earned);
    playLaunchSfx();
    // show result in tab 3
    const lr=document.getElementById('launch-result');
    lr.classList.add('show');
    document.getElementById('lr-stats').innerHTML=`
      <span class="launch-result-stat-lbl">ê¸°ì²´</span><span class="launch-result-stat-val">${q.name}</span>
      <span class="launch-result-stat-lbl">Î”v</span><span class="launch-result-stat-val">${sci.deltaV.toFixed(2)} km/s</span>
      <span class="launch-result-stat-lbl">TWR</span><span class="launch-result-stat-val">${sci.twr.toFixed(2)}</span>
      <span class="launch-result-stat-lbl">ìµœê³ ë„</span><span class="launch-result-stat-val">${Math.floor(sci.altitude)} km</span>
      <span class="launch-result-stat-lbl">ì‹ ë¢°ë„</span><span class="launch-result-stat-val">${sci.reliability.toFixed(1)}%</span>
    `;
    document.getElementById('lr-ms').textContent=`ë¬¸ìŠ¤í†¤ ë³´ìƒ: +${earned}ê°œ`;
  },4600);
}
function showLaunchOverlay(q,sci,earned){
  document.getElementById('lo-rocket-art').textContent=
`        *
       /|\\
      / | \\
     /  |  \\
    / BETA  \\
   /__mk.2__\\
  |          |
  |  ENGINE  |
  |__________|`;
  document.getElementById('lo-stats').innerHTML=
    `ê¸°ì²´: ${q.name}  |  Î”v: ${sci.deltaV.toFixed(2)} km/s  |  ê³ ë„: ${Math.floor(sci.altitude)} km<br>TWR: ${sci.twr.toFixed(2)}  |  ì‹ ë¢°ë„: ${sci.reliability.toFixed(1)}%`;
  document.getElementById('lo-ms').textContent=`ë¬¸ìŠ¤í†¤ +${earned}ê°œ íšë“ ì˜ˆì •`;
  document.getElementById('launch-overlay').classList.add('show');
}
function closeLaunchOverlay(){
  document.getElementById('launch-overlay').classList.remove('show');
  renderTab(activeTab);
}
function confirmLaunch(){
  gs.moonstone+=pendingLaunchMs;
  // Prestige reset
  gs.res={money:500,metal:0,fuel:0,electronics:0,research:0};
  gs.buildings={ops_center:0,supply_depot:0,mine:0,extractor:0,refinery:0,cryo_plant:0,elec_lab:0,fab_plant:0,research_lab:0,r_and_d:0,solar_array:0,launch_pad:0};
  gs.parts={engine:0,fueltank:0,control:0,hull:0,payload:0};
  gs.assembly={selectedQuality:'proto',jobs:[]};
  gs.upgrades={};
  prodMult={};
  globalMult=1;
  partCostMult=1;
  fusionBonus=0;
  reliabilityBonus=0;
  slotBonus=0;
  document.getElementById('launch-overlay').classList.remove('show');
  notify(`ë¬¸ìŠ¤í†¤ ${gs.moonstone}ê°œ ë³´ìœ  â€” ìƒì‚° +${gs.moonstone*5}%`,'');
  playSfx('triangle',500,0.12,0.04,760);
  saveGame();
  renderAll();
}

// ============================================================
//  TICK / OFFLINE
// ============================================================
function tick(){
  const now=Date.now();
  const dt=Math.min((now-gs.lastTick)/1000,1);
  gs.lastTick=now;
  const prod=getProduction();
  RESOURCES.forEach(r=>{gs.res[r.id]=(gs.res[r.id]||0)+prod[r.id]*dt;});
  updateAssemblyJobs(now);
}
function updateAssemblyJobs(now=Date.now()){
  ensureAssemblyState();
  for(let i=0;i<gs.assembly.jobs.length;i++){
    const job=gs.assembly.jobs[i];
    if(!job||job.ready) continue;
    if(now>=job.endAt){
      job.ready=true;
      notify(`ìŠ¬ë¡¯ ${i+1}: ${getQuality(job.qualityId).name} ì¡°ë¦½ ì™„ë£Œ`);
    }
  }
}
function calcOffline(){
  const now=Date.now();
  const elapsed=Math.min((now-gs.lastTick)/1000,8*3600);
  if(elapsed<5){gs.lastTick=now;return;}
  const prod=getProduction();
  RESOURCES.forEach(r=>{gs.res[r.id]=(gs.res[r.id]||0)+prod[r.id]*elapsed;});
  gs.lastTick=now;
  updateAssemblyJobs(now);
  const mins=Math.floor(elapsed/60);
  if(mins>0){
    const banner=document.getElementById('offline-banner');
    banner.style.display='block';
    banner.textContent=`ì˜¤í”„ë¼ì¸ ${mins}ë¶„ â€” ìì› ìƒì‚° ì™„ë£Œ`;
    setTimeout(()=>banner.style.display='none',5000);
  }
}

// ============================================================
//  SAVE / LOAD
// ============================================================
const SAVE_KEY='moonIdle_v2';
function saveGame(){
  const save={
    saveVersion:2,gs,prodMult,globalMult,partCostMult,
    fusionBonus,reliabilityBonus,slotBonus,lastSave:Date.now()
  };
  try{localStorage.setItem(SAVE_KEY,JSON.stringify(save));}catch(e){}
}
function loadGame(){
  try{
    const raw=localStorage.getItem(SAVE_KEY);
    if(!raw) return false;
    const save=JSON.parse(raw);
    // merge gs
    if(save.gs){
      Object.assign(gs.res,save.gs.res||{});
      Object.assign(gs.buildings,save.gs.buildings||{});
      Object.assign(gs.parts,save.gs.parts||{});
      gs.launches=save.gs.launches||0;
      gs.moonstone=save.gs.moonstone||0;
      gs.history=save.gs.history||[];
      gs.upgrades=save.gs.upgrades||{};
      gs.assembly=save.gs.assembly||{selectedQuality:'proto',jobs:[]};
      gs.settings=save.gs.settings||{sound:true};
      gs.lastTick=save.gs.lastTick||Date.now();
    }
    if(typeof save.prodMult==='object') Object.assign(prodMult,save.prodMult);
    globalMult=save.globalMult||1;
    partCostMult=save.partCostMult||1;
    fusionBonus=save.fusionBonus||0;
    reliabilityBonus=save.reliabilityBonus||0;
    slotBonus=save.slotBonus||0;
    ensureAssemblyState();
    return true;
  }catch(e){console.warn('Load failed',e);return false;}
}
function hasSave(){
  try{return !!localStorage.getItem(SAVE_KEY);}catch(e){return false;}
}

// ============================================================
//  RENDER HELPERS
// ============================================================
function renderResourceBar(){
  const prod=getProduction();
  let html='';
  RESOURCES.forEach(r=>{
    const rate=prod[r.id]||0;
    const rateStr=rate>0.001?` <span class="rate">(+${fmtDec(rate,1)}/s)</span>`:'';
    html+=`<div class="res-cell" style="color:${r.color}">
      ${r.symbol}: <strong>${fmt(gs.res[r.id]||0)}</strong>${rateStr}
    </div>`;
  });
  html+=`<div class="res-cell ms">ğŸŒ™ ë¬¸ìŠ¤í†¤: <strong>${gs.moonstone}</strong></div>`;
  document.getElementById('res-bar-inner').innerHTML=html;
  document.getElementById('sound-btn').textContent=gs.settings.sound?'SND:ON':'SND:OFF';
  document.getElementById('sound-btn').style.color=gs.settings.sound?'var(--green-mid)':'var(--red)';
}

// ============================================================
//  TAB 0: PRODUCTION HUB
// ============================================================

// ASCII building art per building id
function getBuildingArt(bid,cnt){
  const w=cnt>0?'â™Ÿ':'Â·';
  const arts={
    ops_center:
`â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [OPS]  ì„¼í„°  â•‘
â•‘  ${w} ${w} ${w} ${w}    â•‘
â•‘  â•â•â•â•â•â•â•â•â•â•  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,
    supply_depot:
`â•”â•â•â•â•â•â•â•â•â•â•â•—
â•‘  [DEP]   â•‘
â•‘ â–“â–“â–“â–“â–“â–“â–“ â•‘
â•‘ ë³´ê¸‰ ì°½ê³   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•`,
    mine:
`  â–²â–²â–²
 â–²â–²â–²â–²â–²
â•”â•â•â•â•â•â•â•—
â•‘[MIN] â•‘
â•‘ ||| ${w}â•‘
â•šâ•â•â•â•â•â•â•
  |||`,
    extractor:
` â•”â•â•â•â•â•—
 â•‘[EXT]â•‘
â•â•£    â• â•
 â•‘ ${w}${w}${w} â•‘
 â•šâ•â•â•â•â•`,
    refinery:
` _â•”â•â•â•—_
â•”â•£  â• â•â•â•—
â•‘â•šâ•â•â•  â•‘
â•‘[REF]${w}â•‘
â•‘ ~~~  â•‘
â•šâ•â•â•â•â•â•â•`,
    cryo_plant:
`â•”â•â•â•â•â•â•â•—
â•‘[CRY] â•‘
â•‘*~*~*~â•‘
â•‘ ${w} ${w} ${w}â•‘
â•šâ•â•â•â•â•â•â•`,
    elec_lab:
`â•”â•â•â•â•â•â•â•—
â•‘[PCB] â•‘
â•‘âŠ™ âŠ™ âŠ™â•‘
â•‘ ${w}${w}${w}  â•‘
â•šâ•â•â•â•â•â•â•`,
    fab_plant:
`â•”â•â•â•â•â•â•â•—
â•‘[FAB] â•‘
â•‘â–¤â–¤â–¤â–¤â–¤â•‘
â•‘ ${w}  ${w} â•‘
â•šâ•â•â•â•â•â•â•`,
    research_lab:
`â•”â•â•â•â•â•â•â•—
â•‘[RSH] â•‘
â•‘ â—â—â— â•‘
â•‘ ${w}  ${w} â•‘
â•šâ•â•â•â•â•â•â•`,
    r_and_d:
`â•”â•â•â•â•â•â•â•—
â•‘[RND] â•‘
â•‘âŒ¬âŒ¬âŒ¬âŒ¬âŒ¬â•‘
â•‘ ${w}${w}${w}  â•‘
â•šâ•â•â•â•â•â•â•`,
    solar_array:
`  â”Œâ”€â”
  â”‚â˜€â”‚
â”Œâ”€â”´â”€â”´â”€â”
â”‚[SOL]â”‚
â””â”€â”€â”€â”€â”€â”˜`,
    launch_pad:
`  __|__
 / [PAD]\\
|  â•â•â•  |
|_______|
  | | |`
  };
  return arts[bid]||`[${bid}]\nÃ—${cnt}`;
}

function renderProdHub(){
  const prod=getProduction();
  const totalIncome=prod.money;
  const workers=getTotalWorkers();
  document.getElementById('prod-status').textContent=
    `[ ì´ ìˆ˜ì…: â‚©${fmtDec(totalIncome,1)}/s ]  [ ì¸ë ¥: ${workers}ëª… ë°°ì¹˜ ]`;

  // ASCII world
  let worldHtml='';
  BUILDINGS.forEach(b=>{
    const cnt=gs.buildings[b.id]||0;
    const art=getBuildingArt(b.id,cnt);
    const cost=getBuildingCost(b);
    const costStr=getCostStr(cost);
    const affordable=canAfford(cost);
    let rateInfo='';
    if(b.produces!=='bonus'){
      const rate=b.baseRate*Math.max(cnt,1)*(prodMult[b.produces]||1)*globalMult*getMoonstoneMult()*getSolarBonus();
      rateInfo=`ìƒì‚°: ${fmtDec(rate,2)} ${b.produces}/s`;
    } else {
      rateInfo=b.id==='solar_array'?`ì „ì²´ ìƒì‚° +${cnt*10}%`:`ì¡°ë¦½ ìŠ¬ë¡¯: ${getAssemblySlots()}`;
    }
    const overlay=
`â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ // ${b.name.padEnd(20)}LV.${cnt} â•‘
â•‘ ${rateInfo.padEnd(28)}â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ [ ì—…ê·¸ë ˆì´ë“œ ]                â•‘
â•‘ ë¹„ìš©: ${costStr.padEnd(23)}â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;
    worldHtml+=`
<div class="building-ascii-wrap" onclick="buyBuilding('${b.id}')">
  <pre class="building-ascii">${art}</pre>
  <div class="bld-count-badge">Ã—${cnt}</div>
  <pre class="bld-hover-overlay">${overlay}</pre>
</div>`;
  });
  document.getElementById('prod-world').innerHTML=worldHtml;

  // Building cards
  let cardsHtml='';
  BUILDINGS.forEach(b=>{
    const cnt=gs.buildings[b.id]||0;
    const cost=getBuildingCost(b);
    const costStr=getCostStr(cost);
    const affordable=canAfford(cost);
    let rateStr='';
    if(b.produces!=='bonus'){
      const rate=b.baseRate*cnt*(prodMult[b.produces]||1)*globalMult*getMoonstoneMult()*getSolarBonus();
      rateStr=`${b.produces} +${fmtDec(rate,2)}/s`;
    } else {
      rateStr=b.id==='solar_array'?`ì „ì²´ ìƒì‚° +${cnt*10}%`:`ë°œì‚¬ ìŠ¬ë¡¯ +${cnt}`;
    }
    cardsHtml+=`
<div class="bld-card">
  <div class="bld-card-top">
    <span class="bld-name">${b.icon} ${b.name}</span>
    <span class="bld-cnt">Ã—${cnt}</span>
  </div>
  <div class="bld-desc">${b.desc}</div>
  <div class="bld-rate">${rateStr}</div>
  <div class="bld-cost">ë¹„ìš©: ${costStr}</div>
  <button class="btn btn-sm btn-full${affordable?'':' btn-amber'}" onclick="buyBuilding('${b.id}')" ${affordable?'':'disabled'}>
    ${affordable?'[ êµ¬ë§¤ ]':'[ ìì› ë¶€ì¡± ]'}
  </button>
</div>`;
  });
  document.getElementById('bld-grid').innerHTML=cardsHtml;
}

// ============================================================
//  TAB 1: RESEARCH
// ============================================================
function renderResearch(){
  // Organize into rows/chains
  const chains=[
    {title:'ê´‘ì—… / ì—°ë£Œ', nodes:['drill','catalyst','alloy','lightweight']},
    {title:'ì „ì / ìë™í™”', nodes:['microchip','automation','reliability','fusion']},
    {title:'ìƒì‚° í™•ì¥', nodes:['multipad']},
  ];
  let html='';
  chains.forEach(chain=>{
    html+=`<div class="upg-tree-section"><div class="upg-tree-section-title">${chain.title}</div><div class="upg-tree-row">`;
    chain.nodes.forEach((uid,i)=>{
      const upg=UPGRADES.find(u=>u.id===uid);
      if(!upg) return;
      const purchased=gs.upgrades[uid];
      const reqMet=!upg.req||gs.upgrades[upg.req];
      let cls='upg-node';
      if(purchased) cls+=' purchased';
      else if(!reqMet) cls+=' locked';
      else if(canAfford(upg.cost)) cls+=' available';
      const costStr=getCostStr(upg.cost);
      const onclick=purchased||!reqMet?'':`onclick="buyUpgrade('${uid}')"`;
      if(i>0) html+=`<span class="upg-connector">â†’</span>`;
      html+=`<div class="${cls}" ${onclick}>
        <div class="upg-node-name">${upg.icon} ${upg.name}</div>
        <div class="upg-node-desc">${upg.desc}</div>
        ${!purchased?`<div class="upg-node-cost">${costStr}</div>`:''}
      </div>`;
    });
    html+='</div></div>';
  });
  document.getElementById('upg-tree-wrap').innerHTML=html;
}

// ============================================================
//  TAB 2: ASSEMBLY
// ============================================================
function renderAssembly(){
  ensureAssemblyState();
  const pd=gs.parts;
  // Rocket art with glow on completed sections
  const noseClass='r-nose'+(pd.hull?' done':'');
  const payloadClass='r-payload'+(pd.payload?' done':'');
  const avionicsClass='r-avionics'+(pd.control?' done':'');
  const engineClass='r-engine'+(pd.engine?' done':'');
  const exhaustClass='r-exhaust'+(pd.fueltank&&pd.engine?' done':'');
  const rocketHtml=`<pre class="rocket-art"><span class="${noseClass}">           *
          /|\\
         / | \\
        /  |  \\
       /   |   \\
      /  BETA   \\
     /   mk.2    \\
    /______________\\</span>
<span class="${payloadClass}">   |  [PAYLOAD]    |
   |   _________   |
   |  |  NAV    |  |
   |  |  SYS    |  |
   |  |_________|  |</span>
<span class="${avionicsClass}">   |               |
   |  [AVIONICS]   |
   |  _________    |
   | | O  O  O |   |
   | |  GYRO   |   |
   | |_________|   |</span>
<span class="${engineClass}">   |               |
   | [PROPULSION]  |
   |  _________    |
   | |         |   |
   | | 156 kN  |   |
   | |_________|   |
   |_______________|</span>
<span class="${exhaustClass}">  / [LOX]  [RP-1]  \\
 /___________________\\
       |   |   |
      /|   |   |\\
     /_|___|___|_\\</span></pre>`;
  document.getElementById('rocket-art-display').innerHTML=rocketHtml;

  // Parts checklist
  let partsHtml='';
  PARTS.forEach(p=>{
    const done=gs.parts[p.id];
    const cost=getPartCost(p);
    const costStr=getCostStr(cost);
    const affordable=canAfford(cost);
    partsHtml+=`<div class="parts-list-item">
      <span class="part-check ${done?'part-done':'part-pending'}">${done?'[âœ“]':'[âœ—]'}</span>
      <span style="flex:1;color:${done?'var(--green)':'var(--green-dim)'};">${p.icon} ${p.name}</span>
      ${done?'<span style="color:var(--green);font-size:12px;">ì™„ë£Œ</span>'
            :`<button class="btn btn-sm${affordable?'':' btn-amber'}" onclick="craftPart('${p.id}')" ${affordable?'':'disabled'}>ì œì‘</button>`}
    </div>
    ${!done?`<div style="font-size:11px;color:var(--green-mid);padding:2px 0 4px 22px;">ë¹„ìš©: ${costStr}</div>`:''}`;
  });
  document.getElementById('parts-checklist').innerHTML=partsHtml;

  // Quality selector
  let qualHtml='';
  QUALITIES.forEach(q=>{
    const active=gs.assembly.selectedQuality===q.id;
    qualHtml+=`<button class="qual-btn${active?' active':''}" onclick="selectQuality('${q.id}')">${q.icon} ${q.name}</button>`;
  });
  document.getElementById('quality-selector').innerHTML=qualHtml;

  // Science box
  const q=getQuality(gs.assembly.selectedQuality);
  const sci=getRocketScience(q.id);
  const reward=getMoonstoneReward(q.id);
  const cost=getAssemblyCost(q.id);
  const costStr=getCostStr(cost);
  document.getElementById('science-box').innerHTML=`
    <div class="label-sm">// ë¡œì¼“ ì œì› â€” ${q.name}</div>
    <div>Î”v: <span class="val">${sci.deltaV.toFixed(2)} km/s</span>  TWR: <span class="val">${sci.twr.toFixed(2)}</span></div>
    <div>ì‹ ë¢°ë„: <span class="val">${sci.reliability.toFixed(1)}%</span>  ì˜ˆìƒ ê³ ë„: <span class="val">${Math.floor(sci.altitude)} km</span></div>
    <div>ì¡°ë¦½ ì‹œê°„: <span class="val">${fmtTime(q.timeSec)}</span>  ì¡°ë¦½ ë¹„ìš©: <span class="ms-val">${costStr}</span></div>
    <div>ì˜ˆìƒ ë¬¸ìŠ¤í†¤ ë³´ìƒ: <span class="ms-val">+${reward}ê°œ</span></div>
  `;

  // Assembly slots
  let slotsHtml='';
  gs.assembly.jobs.forEach((job,idx)=>{
    if(!job){
      const canStart=PARTS.every(p=>gs.parts[p.id])&&canAfford(cost);
      slotsHtml+=`<div class="slot-card">
        <div class="slot-card-header">
          <span class="slot-title">// ì¡°ë¦½ ìŠ¬ë¡¯ ${idx+1}</span>
          <span class="slot-state idle">ëŒ€ê¸° ì¤‘</span>
        </div>
        <div style="font-size:12px;color:var(--green-mid);margin-bottom:6px;">
          ì„ íƒ: ${q.name}  |  ë¹„ìš©: ${costStr}
        </div>
        <button class="btn btn-full btn-sm${canStart?'':' btn-amber'}" onclick="startAssembly(${idx})" ${canStart?'':'disabled'}>
          ${canStart?'[ â–¶ ì¡°ë¦½ ì‹œì‘ ]':'[ ë¶€í’ˆ/ìì› ë¶€ì¡± ]'}
        </button>
      </div>`;
    } else if(job.ready){
      const ms=getMoonstoneReward(job.qualityId);
      slotsHtml+=`<div class="slot-card" style="border-color:var(--green);">
        <div class="slot-card-header">
          <span class="slot-title glow">// ìŠ¬ë¡¯ ${idx+1} â€” ${getQuality(job.qualityId).name}</span>
          <span class="slot-state ready">ë°œì‚¬ ì¤€ë¹„!</span>
        </div>
        <div style="font-size:12px;color:var(--green-mid);margin-bottom:6px;">
          ì˜ˆìƒ ë¬¸ìŠ¤í†¤: +${ms}ê°œ
        </div>
        <button class="btn btn-full btn-sm btn-amber" onclick="launchFromSlot(${idx})">
          [ â–¶â–¶ ë°œì‚¬ ì‹¤í–‰ ]
        </button>
      </div>`;
    } else {
      const remain=Math.max(0,Math.floor((job.endAt-Date.now())/1000));
      const total=Math.max(1,Math.floor((job.endAt-job.startAt)/1000));
      const pct=Math.min(100,((total-remain)/total)*100);
      slotsHtml+=`<div class="slot-card" style="border-color:var(--amber);">
        <div class="slot-card-header">
          <span class="slot-title">// ìŠ¬ë¡¯ ${idx+1} â€” ${getQuality(job.qualityId).name}</span>
          <span class="slot-state busy">ì¡°ë¦½ ì¤‘ ${fmtTime(remain)}</span>
        </div>
        <div class="prog-wrap"><div class="prog-fill amber" style="width:${pct}%"></div></div>
        <div style="font-size:11px;color:var(--green-mid);">${pct.toFixed(0)}% ì™„ë£Œ</div>
      </div>`;
    }
  });
  document.getElementById('assembly-slots-wrap').innerHTML=slotsHtml;
}

// ============================================================
//  TAB 3: LAUNCH CONTROL
// ============================================================
function renderLaunchControl(){
  ensureAssemblyState();
  let readyHtml='';
  let hasReady=false;
  gs.assembly.jobs.forEach((job,idx)=>{
    if(!job) return;
    if(job.ready){
      hasReady=true;
      const ms=getMoonstoneReward(job.qualityId);
      readyHtml+=`<div class="ready-slot-row">
        <span style="color:var(--green);">ìŠ¬ë¡¯ ${idx+1}: ${getQuality(job.qualityId).name}</span>
        <span style="color:var(--green);font-size:12px;">[ì¤€ë¹„ ì™„ë£Œ]</span>
        <button class="btn btn-sm btn-amber" onclick="launchFromSlot(${idx})">[ â–¶â–¶ ë°œì‚¬ ]</button>
      </div>`;
    } else {
      const remain=Math.max(0,Math.floor((job.endAt-Date.now())/1000));
      readyHtml+=`<div class="ready-slot-row">
        <span style="color:var(--amber);">ìŠ¬ë¡¯ ${idx+1}: ${getQuality(job.qualityId).name}</span>
        <span style="color:var(--amber);font-size:12px;">ì¡°ë¦½ ì¤‘ ${fmtTime(remain)}</span>
      </div>`;
    }
  });
  if(!readyHtml) readyHtml='<div style="color:var(--green-dim);font-size:13px;">// ì¤€ë¹„ëœ ë¡œì¼“ì´ ì—†ìŠµë‹ˆë‹¤. ì¡°ë¦½ë™ì—ì„œ ë¡œì¼“ì„ ì¡°ë¦½í•˜ì„¸ìš”.</div>';
  document.getElementById('ready-list-wrap').innerHTML=readyHtml;
}

// ============================================================
//  TAB 4: MISSION PROGRESS
// ============================================================
function renderMissionProgress(){
  // Phase definitions
  const phases=[
    {name:'PHASE 1: í”„ë¡œí† íƒ€ì…', target:1,    unit:'íšŒ', key:'launches' },
    {name:'PHASE 2: ì¤€ê¶¤ë„',     target:100,  unit:'km', key:'altitude100' },
    {name:'PHASE 3: ê¶¤ë„',       target:200,  unit:'km', key:'altitude200' },
    {name:'PHASE 4: ì‹œìŠ¤ë£¨ë‚˜',   target:300,  unit:'km', key:'altitude300' },
    {name:'PHASE 5: ë‹¬ ì°©ë¥™',    target:384400,unit:'km',key:'moon' },
  ];
  const maxAlt=gs.history.length?Math.max(...gs.history.map(h=>Number(h.altitude)||0)):0;
  const vals={
    launches:gs.launches,
    altitude100:maxAlt,
    altitude200:maxAlt,
    altitude300:maxAlt,
    moon:maxAlt
  };
  const targets={launches:1,altitude100:100,altitude200:200,altitude300:300,moon:384400};
  let phaseHtml='';
  phases.forEach((ph,i)=>{
    const val=vals[ph.key];
    const tgt=targets[ph.key];
    const pct=Math.min(100,(val/tgt)*100);
    const done=pct>=100;
    // Unlock: phase 1 always, phase 2 if launches>0, etc.
    const locked=i>0&&!done&&(i>=2&&maxAlt<(i===2?100:i===3?200:300))&&gs.launches<1;
    phaseHtml+=`<div class="phase-row">
      <div class="phase-name">${ph.name}</div>
      <div class="phase-bar-wrap">
        <div class="phase-bar-fill${done?' done':''}" style="width:${pct}%"></div>
      </div>
      <div class="phase-status${done?' done':locked?' locked':''}">
        ${done?'ì™„ë£Œ âœ“':locked?'ì ê¸ˆ':'ì§„í–‰ ì¤‘'}
      </div>
    </div>`;
  });
  document.getElementById('phase-progress-wrap').innerHTML=phaseHtml;

  // History table
  let histHtml='';
  if(gs.history.length===0){
    histHtml='<div style="color:var(--green-dim);font-size:13px;padding:8px 0;">// ë°œì‚¬ ê¸°ë¡ ì—†ìŒ</div>';
  } else {
    histHtml=`<table class="history-table">
      <thead><tr>
        <th>NO.</th><th>ë‚ ì§œ</th><th>ê¸°ì²´</th><th>Î”v</th><th>ìµœê³ ë„</th><th>ì‹ ë¢°ë„</th>
      </tr></thead><tbody>`;
    gs.history.forEach(h=>{
      histHtml+=`<tr>
        <td>${String(h.no).padStart(3,'0')}</td>
        <td>${h.date}</td>
        <td>${h.quality}</td>
        <td>${h.deltaV} km/s</td>
        <td>${h.altitude} km</td>
        <td>${h.reliability}%</td>
      </tr>`;
    });
    histHtml+='</tbody></table>';
  }
  document.getElementById('history-wrap').innerHTML=histHtml;

  // Prestige
  let prestigeHtml='';
  if(gs.launches>0){
    const nextBonus=(gs.moonstone+1)*5;
    prestigeHtml=`<div class="prestige-panel">
      <div class="panel-header">í”„ë ˆìŠ¤í‹°ì§€ â€” ìƒˆ ì‹œì¦Œ</div>
      <div class="prestige-stat">í˜„ì¬ ë¬¸ìŠ¤í†¤: <strong>${gs.moonstone}ê°œ</strong></div>
      <div class="prestige-stat">í˜„ì¬ ìƒì‚° ë³´ë„ˆìŠ¤: <strong>+${gs.moonstone*5}%</strong></div>
      <div style="font-size:12px;color:var(--amber);margin-bottom:10px;">
        // ë‹¤ìŒ ë°œì‚¬ í›„ ì¬ì‹œì‘í•˜ë©´ ë¬¸ìŠ¤í†¤ì´ ëˆ„ì ë©ë‹ˆë‹¤
      </div>
    </div>`;
  }
  document.getElementById('prestige-wrap').innerHTML=prestigeHtml;
}

// ============================================================
//  RENDER ALL / RENDER TAB
// ============================================================
function renderTab(idx){
  if(idx===0) renderProdHub();
  else if(idx===1) renderResearch();
  else if(idx===2) renderAssembly();
  else if(idx===3) renderLaunchControl();
  else if(idx===4) renderMissionProgress();
}
function renderAll(){
  renderResourceBar();
  renderTab(activeTab);
}

// ============================================================
//  TITLE SCREEN
// ============================================================
const BOOT_LINES=[
  'MOONIDLE MISSION CONTROL v2.0',
  'COPYRIGHT (C) PRIMORDIAL STATION DEV',
  'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
  'INITIALIZING HARDWARE...',
  '  [OK] CPU CORE 0-3',
  '  [OK] MEMORY 4096MB',
  '  [OK] DISPLAY PHOSPHOR-GREEN',
  'LOADING SUBSYSTEMS...',
  '  [OK] RESOURCE MANAGER',
  '  [OK] PRODUCTION ENGINE',
  '  [OK] ROCKET ASSEMBLY',
  '  [OK] LAUNCH SEQUENCER',
  '  [OK] SAVE/LOAD (localStorage)',
  'CHECKING TELEMETRY LINK... NOMINAL',
  'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
  'SYSTEM READY. AWAITING COMMANDER INPUT.',
];

function runBootSequence(cb){
  const log=document.getElementById('boot-log');
  log.innerHTML='';
  BOOT_LINES.forEach((line,i)=>{
    const span=document.createElement('span');
    span.className='boot-line';
    span.textContent=line;
    span.style.animationDelay=(i*130)+'ms';
    log.appendChild(span);
  });
  setTimeout(cb, BOOT_LINES.length*130+400);
}

function updateSaveStrip(){
  const strip=document.getElementById('save-strip');
  if(hasSave()){
    const raw=localStorage.getItem(SAVE_KEY);
    const save=JSON.parse(raw);
    const sg=save.gs||{};
    const ls=save.lastSave?new Date(save.lastSave).toLocaleDateString('ko-KR'):'?';
    strip.innerHTML=`ì„¸ì´ë¸Œ ë°œê²¬ â€” ë§ˆì§€ë§‰ ì €ì¥: <span>${ls}</span>  ë°œì‚¬ íšŸìˆ˜: <span>${sg.launches||0}</span>íšŒ  ë¬¸ìŠ¤í†¤: <span>${sg.moonstone||0}</span>ê°œ`;
    document.getElementById('continue-btn').style.display='inline-block';
  } else {
    strip.innerHTML='<span>ì„¸ì´ë¸Œ ì—†ìŒ</span>';
    document.getElementById('continue-btn').style.display='none';
  }
}

function startNewGame(){
  // Reset everything
  gs.res={money:500,metal:0,fuel:0,electronics:0,research:0};
  gs.buildings={ops_center:0,supply_depot:0,mine:0,extractor:0,refinery:0,cryo_plant:0,elec_lab:0,fab_plant:0,research_lab:0,r_and_d:0,solar_array:0,launch_pad:0};
  gs.parts={engine:0,fueltank:0,control:0,hull:0,payload:0};
  gs.assembly={selectedQuality:'proto',jobs:[]};
  gs.upgrades={};
  gs.launches=0;
  gs.moonstone=0;
  gs.history=[];
  gs.lastTick=Date.now();
  gs.settings={sound:true};
  prodMult={};
  globalMult=1;
  partCostMult=1;
  fusionBonus=0;
  reliabilityBonus=0;
  slotBonus=0;
  saveGame();
  launchGame();
}

function continueGame(){
  const ok=loadGame();
  if(!ok){startNewGame();return;}
  calcOffline();
  launchGame();
}

function openSettings(){
  const on=gs.settings.sound;
  gs.settings.sound=!on;
  notify(`ì‚¬ìš´ë“œ ${gs.settings.sound?'ON':'OFF'}`);
  playSfx('sine',640,0.06,0.03,720);
}

function launchGame(){
  const ts=document.getElementById('title-screen');
  ts.classList.add('fade-out');
  setTimeout(()=>{
    ts.style.display='none';
    document.getElementById('app').classList.add('visible');
    ensureAssemblyState();
    renderAll();
  },800);
}

// ============================================================
//  INIT
// ============================================================
(function init(){
  runBootSequence(()=>{
    updateSaveStrip();
  });

  // Game loop
  setInterval(()=>{tick();},200);
  // Render loop
  setInterval(()=>{renderAll();},500);
  // Autosave
  setInterval(()=>{saveGame();},10000);
  // Visibility
  document.addEventListener('visibilitychange',()=>{
    if(!document.hidden) calcOffline();
  });
})();
</script>
</body>
</html>
